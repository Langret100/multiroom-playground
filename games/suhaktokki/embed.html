<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>수학토끼</title>
  <link rel="icon" href="../../favicon.ico" />
  <link rel="preload" as="image" href="assets/mathrabbitloading.png" />
  <script>
  // Embed-only entry: always run in embed mode.
  // (This file is used by the parent "방" page iframe.)
  (function(){
    try{ document.documentElement.classList.add('embed'); }catch(_){ }
  })();
  </script>
  <script>
  // Buffer bridge_init/game_start in case they arrive before game.js attaches listeners.
  (function(){
    try{
      window.__PENDING_BRIDGE_INIT__ = window.__PENDING_BRIDGE_INIT__ || null;
      window.__PENDING_GAME_START__ = window.__PENDING_GAME_START__ || null;
      window.addEventListener('message', function(ev){
        var d = ev.data;
        if (typeof d === 'string'){ try{ d = JSON.parse(d); }catch(e){ return; } }
        if (!d || typeof d !== 'object') return;
        if (d.type === 'bridge_init') window.__PENDING_BRIDGE_INIT__ = d;
        if (d.type === 'game_start') window.__PENDING_GAME_START__ = d;
      });
      // tell parent we exist as early as possible
      try{ window.parent && window.parent.postMessage({type:'bridge_ready'},'*'); }catch(e){}
    }catch(e){}
  })();
  </script>
  <style>
    :root{--bg:#0c1220;--panel:#121a2e;--line:rgba(255,255,255,.12);--txt:#f4f7ff;--muted:rgba(244,247,255,.72);--accent:#66e0a3;--danger:#ff5a7a;--actW:200px;--actH:88px;--actGap:16px;--actStep:calc(var(--actH) + var(--actGap))}
    *{box-sizing:border-box;touch-action:none;-webkit-user-select:none;user-select:none;}
    html,body{width:100%;height:100%;margin:0;overflow:hidden;background:radial-gradient(1200px 800px at 50% 10%,#1a2642,#0c1220);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    canvas{background:#0b0f1a;border-radius:0;box-shadow:none;image-rendering:pixelated;image-rendering:crisp-edges;}

    /* Embed: parent page already owns the "lobby". Keep the iframe as pure gameplay.
       Also remove the rounded/shadowed stage to avoid the "flash" users reported. */
    html.embed canvas{border-radius:0 !important; box-shadow:none !important;}
    html.embed #lobby{display:none !important;}

    /* HUD */
    #hud{position:fixed;left:0;top:0;right:0;z-index:20;pointer-events:none;display:flex;gap:8px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;
      padding:
        calc(10px + env(safe-area-inset-top))
        calc(10px + env(safe-area-inset-right))
        calc(10px + env(safe-area-inset-bottom))
        calc(10px + env(safe-area-inset-left));
    }
    #leftHud{display:flex;gap:8px;align-items:flex-start;pointer-events:none;}
    .pill{pointer-events:auto;background:rgba(18,26,46,.75);backdrop-filter:blur(8px);border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-weight:800;font-size:13px;display:flex;gap:10px;align-items:center;}
    #roomPill{padding:7px 10px;font-size:12px;opacity:.9}
    .pill small{font-weight:800;color:var(--muted)}
    .bar{width:120px;height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#7dd3fc);}
    #rightHud{display:flex;gap:8px;align-items:flex-start;justify-content:flex-end;flex-wrap:wrap;max-width:70vw;}
    button.ui{pointer-events:auto;border:1px solid var(--line);background:rgba(18,26,46,.75);color:var(--txt);border-radius:12px;padding:10px 12px;font-weight:900;font-size:13px;cursor:pointer;}
    button.ui:active{transform:translateY(1px)}
    button.ui.mini{padding:7px 9px;border-radius:10px;font-size:12px;}
    button.ui.icon{width:30px;height:30px;padding:0;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-size:14px;}

    /* Visibility helpers */
    #lobby.hidden{display:none;}
    .modal.show{display:flex;}

    /* Lobby */
    #lobby{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:18px;}
    #lobbyCard{width:min(560px,92vw);background:rgba(18,26,46,.92);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:0 30px 90px rgba(0,0,0,.55)}
    #title{font-size:28px;font-weight:900;letter-spacing:-.5px;display:flex;align-items:center;gap:10px;margin:0 0 6px;}
    #subtitle{margin:0 0 14px;color:var(--muted);font-weight:700;}
    #lobbyStatus{margin:0 0 10px;color:rgba(244,247,255,.82);font-weight:800;font-size:12px;line-height:1.35;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .field{flex:1;min-width:170px;display:flex;flex-direction:column;gap:6px;margin:10px 0;}
    label{font-size:12px;color:var(--muted);font-weight:800;}
    input{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--txt);border-radius:12px;padding:12px 12px;font-size:14px;font-weight:800;outline:none;}
    #lobbyActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .primary{background:linear-gradient(180deg,#66e0a3,#33c38a);border:0;color:#081022;}
    .danger{background:linear-gradient(180deg,#ff5a7a,#ff2f66);border:0;color:#1a0610;}
    .note{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35;}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);margin-right:6px;}

    /* Roster */
    #roster{margin-top:12px;padding:12px 12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:14px;}
    #rosterHead{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;}
    #rosterHead b{font-size:13px;}
    #rosterMeta{font-size:12px;color:var(--muted);font-weight:800;}
    #rosterList{display:flex;flex-wrap:wrap;gap:8px;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(18,26,46,.55);font-weight:900;font-size:12px;}
    .chip i{display:inline-block;width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.45);}
    .chip .bot{opacity:.85;font-weight:1000;color:rgba(125,211,252,.95)}

    /* Touch UI */
    #touchUI{position:fixed;inset:0;z-index:19;pointer-events:none;display:none;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    #joy{position:absolute;left:calc(14px + env(safe-area-inset-left));bottom:calc(14px + env(safe-area-inset-bottom));width:180px;height:180px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(6px);}
    #joyKnob{position:absolute;left:50%;top:50%;width:80px;height:80px;border-radius:999px;transform:translate(-50%,-50%);background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);}
    #interactBtn,#killBtn,#saboBtnTouch,#forceBtnTouch{position:absolute;right:calc(14px + env(safe-area-inset-right));width:var(--actW);height:var(--actH);border-radius:22px;display:flex;align-items:center;justify-content:center;font-weight:1000;font-size:22px;opacity:.35;pointer-events:none;}
    /* 2x2 grid (Together-style thumb reach) */
    #interactBtn{bottom:calc(18px + env(safe-area-inset-bottom));background:linear-gradient(180deg,#66e0a3,#33c38a);border:0;color:#071022;}
    #killBtn{bottom:calc(18px + env(safe-area-inset-bottom) + var(--actStep));background:linear-gradient(180deg,#222,#000);border:1px solid rgba(255,255,255,.12);color:#fff;font-size:20px;}
    #forceBtnTouch{right:calc(14px + env(safe-area-inset-right) + var(--actW) + var(--actGap));bottom:calc(18px + env(safe-area-inset-bottom));background:linear-gradient(180deg,#a855f7,#7c3aed);border:1px solid rgba(255,255,255,.12);color:#fff;font-size:20px;}
    #saboBtnTouch{right:calc(14px + env(safe-area-inset-right) + var(--actW) + var(--actGap));bottom:calc(18px + env(safe-area-inset-bottom) + var(--actStep));background:linear-gradient(180deg,#3b82f6,#1d4ed8);border:1px solid rgba(255,255,255,.12);color:#fff;font-size:20px;}

    /* Small screens: avoid HUD buttons going off-screen */
    @media (max-width: 520px){
      :root{--actW:132px;--actH:68px;--actGap:10px;--actStep:calc(var(--actH) + var(--actGap));}
      #joy{width:150px;height:150px;}
      #joyKnob{width:68px;height:68px;}

      .pill{padding:6px 10px;font-size:12px;}
      .bar{width:92px;}
      button.ui.mini{padding:6px 8px;border-radius:10px;font-size:11px;}
      #rightHud{gap:6px;max-width:100%;}
    }
    @media (max-width: 390px){
      #rightHud{max-width:100%;}
      button.ui.icon{width:28px;height:28px;border-radius:10px;}
    }
    #interactBtn.ready,#killBtn.ready,#saboBtnTouch.ready,#forceBtnTouch.ready{opacity:1;pointer-events:auto;}
    /* When the nearest interactable is a door, make the button a bit bigger & clearer */
    #interactBtn.doorHint{transform:scale(1.08);box-shadow:0 10px 28px rgba(0,0,0,.35),0 0 0 2px rgba(102,224,163,.35);}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;}
    .sheet{width:min(560px,92vw);background:rgba(18,26,46,.92);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 40px 110px rgba(0,0,0,.6);}
    .sheet h2{margin:0 0 6px;font-size:18px;}
    .sheet p{margin:0 0 12px;color:var(--muted);font-weight:700;}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:12px 0;}
    .wide{width:100%;}

    /* Meeting (Among-Us style): roster + chat + vote */
    #meetingGrid{display:flex;gap:12px;align-items:stretch;}
    #meetingLeftPane{flex:1;min-width:280px;display:flex;flex-direction:column;gap:10px;}
    #meetingRightPane{width:220px;max-width:35vw;}
    #voteList{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto;padding-right:2px;}
    #voteList .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);}
    #meetingRoster{display:flex;flex-wrap:wrap;gap:8px;align-items:center;min-height:34px;}
    .mAvatar{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(18,26,46,.55);font-weight:1000;font-size:12px;}
    .mTokki{width:22px;height:24px;image-rendering:pixelated;border-radius:8px;flex:0 0 auto;}
    .mDot{width:18px;height:18px;border-radius:999px;border:1px solid rgba(255,255,255,.22);display:inline-flex;align-items:center;justify-content:center;font-size:12px;}
    .mDead{opacity:.45;filter:saturate(.7);}
    #meetingChatLog{height:300px;overflow:auto;border-radius:14px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);padding:10px;display:flex;flex-direction:column;gap:8px;}
    .mLine{display:flex;gap:10px;align-items:flex-start;}
    .mBubble{flex:1;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);padding:8px 10px;font-weight:850;line-height:1.25;}
    .mMeta{display:flex;gap:8px;align-items:center;margin-bottom:4px;}
    .mNick{font-weight:1000;font-size:12px;}
    .mTime{font-size:11px;color:rgba(244,247,255,.60);font-weight:900;}
    #meetingChatInputRow{display:flex;gap:10px;align-items:stretch;}
    #meetingChatText{flex:1;height:42px;}
    #meetingChatSend{min-width:76px;white-space:nowrap;}

    /* Meeting layout on small screens */
    @media (max-width: 700px){
      .sheet{width:min(640px,94vw);}
      #meetingGrid{flex-direction:column;}
      #meetingRightPane{width:100%;max-width:100%;}
      #meetingRoster{max-height:54px;overflow-x:auto;overflow-y:hidden;flex-wrap:nowrap;}
      #meetingChatLog{height:240px;}
    }

    /* Scene */
    #sceneCanvas{width:100%;height:210px;border-radius:14px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);margin:8px 0 10px;}

    /* Map canvas inside modal */
    #mapUiCanvas{width:100%;height:420px;border-radius:14px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);margin:8px 0 10px;}
    .legend{display:flex;flex-wrap:wrap;gap:10px;color:var(--muted);font-weight:800;font-size:12px;}
    .legend span{display:inline-flex;align-items:center;gap:6px;}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.45);display:inline-block;}

    /* Canvas sizing */
    #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;}

    /* Boot loading overlay (deprecated): users requested removing the blocking
       overlay entirely, because any asset/join hiccup would leave the iframe
       stuck forever behind it. We keep the DOM nodes for compatibility but
       never display them. */
    #bootLoading{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:#000;pointer-events:none;}
    html.embed #bootLoading{display:none !important;}
    #bootLoading.hidden{display:none;}
    #bootLoading .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
    #bootLoading .hint{position:relative;z-index:1;margin-top:32vh;padding:10px 14px;border-radius:14px;
      background:rgba(0,0,0,.42);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(6px);
      color:rgba(255,255,255,.95);font-weight:950;font-size:14px;letter-spacing:-.2px;}
  </style>
</head>
<body>
  <!-- Boot overlay (embed): keep this visible until assets + all players are ready, then hide once. -->
  <div id="bootLoading">
    <img class="bg" src="assets/mathrabbitloading.png" alt="loading" />
    <div class="hint" id="bootLoadingText">로딩 중...</div>
  </div>

  <div id="wrap"><canvas id="gameCanvas" width="960" height="540"></canvas></div>

  <div id="hud" style="display:none">
    <div id="leftHud">
      <button class="ui icon" id="rulesBtn" title="게임 규칙">?</button>
      <div class="pill">
        <span>⏱️ <span id="timeText">03:00</span></span>
        <span class="bar" title="남은 시간"><i id="progFill"></i></span>
        <small id="progText">0/8</small>
      </div>
    </div>
    <div id="rightHud">
      <div class="pill" id="rolePill" style="display:none"><span id="roleText"></span></div>
      <div class="pill" id="roomPill" style="display:none"><span id="roomText"></span></div>
      <button class="ui mini" id="mapBtn">지도</button>
      <button class="ui mini" id="forceBtn" style="display:none">강제미션</button>
      <button class="ui mini" id="saboBtn" style="display:none">물막기</button>
      <button class="ui mini" id="fullscreenBtn">전체화면</button>
      <button class="ui mini" id="exitBtn">나가기</button>
    </div>
  </div>

  <div id="touchUI">
    <div id="joy"><div id="joyKnob"></div></div>
    <div id="interactBtn">조작</div>
    <div id="killBtn">검은당근</div>
    <div id="forceBtnTouch">강제미션</div>
    <div id="saboBtnTouch">물막기</div>
  </div>

  <!-- Hidden lobby elements (embed entry).
       The parent room owns nick/room/start UI. We keep minimal nodes so game.js can bind safely. -->
  <div id="lobby" style="display:none">
    <p id="lobbyStatus"></p>
    <input id="nick" maxlength="10" />
    <input id="room" maxlength="256" />
    <button id="joinBtn" type="button"></button>
    <button id="addBotBtn" type="button"></button>
    <button id="startBtn" type="button"></button>
    <div id="roster" style="display:none">
      <span id="rosterMeta"></span>
      <div id="rosterList"></div>
    </div>
  </div>

  <div class="modal" id="missionModal">
    <div class="sheet">
      <h2 id="missionTitle">미션</h2>
      <p id="missionDesc">문제 3개를 맞히면 해결!</p>
      <div class="divider"></div>
      <div id="qArea"></div>
      <div class="divider"></div>
      <button class="ui wide" id="closeMission">닫기</button>
    </div>
  </div>

  <div class="modal" id="meetingModal">
    <div class="sheet">
      <h2>회의 · 투표</h2>
      <p id="meetingInfo">누가 선생토끼일까?</p>
      <div class="divider"></div>
      <!-- Among-Us style meeting: roster + chat + vote -->
      <div id="meetingGrid">
        <div id="meetingLeftPane">
          <div id="meetingRoster"></div>
          <div id="meetingChatLog" aria-label="회의 채팅"></div>
          <div id="meetingChatInputRow">
            <input id="meetingChatText" maxlength="120" placeholder="회의 채팅…" />
            <button class="ui" id="meetingChatSend">보내기</button>
          </div>
        </div>

        <div id="meetingRightPane">
          <div id="voteList"></div>
          <div class="divider" style="margin:12px 0"></div>
          <button class="ui wide" id="skipVote">스킵</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="sceneModal">
    <div class="sheet">
      <h2 id="sceneTitle">추방</h2>
      <canvas id="sceneCanvas" width="520" height="210"></canvas>
      <p id="sceneText">...</p>
      <button class="ui wide" id="sceneOk">계속</button>
    </div>
  </div>

  <!-- Rules modal -->
  <div class="modal" id="rulesModal">
    <div class="sheet">
      <h2>게임 규칙</h2>
      <p>미션을 해결해 학생토끼(학생)가 승리하거나, 선생토끼(임포스터)가 시간을 0으로 만들면 선생토끼 승리!</p>
      <div class="divider"></div>
      <div style="color:rgba(244,247,255,.88);font-weight:800;font-size:13px;line-height:1.5">
        <div style="margin-bottom:8px"><b>기본</b><br/>- 가까이서 <b>조작</b>하면 미션/시설 사용<br/>- 활성 미션은 바닥 분수에 <b>!</b> 표시</div>
        <div style="margin-bottom:8px"><b>단축키(PC)</b><br/>
          - 이동: <b>WASD</b> / <b>방향키</b><br/>
          - 조작/공격: <b>X</b><br/>
          - 지도: <b>C</b> (※ 회의 중엔 열리지 않음)<br/>
          - (선생토끼) 사보타주: <b>Q</b> · 강제미션: <b>F</b><br/>
          - 감정표현: <b>1</b>, <b>2</b>
        </div>
        <div style="margin-bottom:8px"><b>오답 페널티(대표)</b><br/>- 단위: 10초 방향 반전<br/>- 뺄셈: 8초 시야 감소<br/>- 그래프: 7초 미션 잠금(자동 재오픈)</div>
        <div style="margin-bottom:8px"><b>시간/누수</b><br/>- 미션 제한시간(60초) 초과 시 실패 → 시간 감소 + 누수 흔적<br/>- 누수 레벨이 높을수록 시간이 더 빨리 줄어듦</div>
        <div><b>선생토끼(4명 이상)</b><br/>- 검은당근으로 다운 유도, 신고/종으로 회의, 물막기 사보타주, 땅굴 이동, 강제미션</div>
      </div>
      <div class="divider"></div>
      <button class="ui wide" id="closeRules">닫기</button>
    </div>
  </div>

  <!-- Map modal -->
  <div class="modal" id="mapModal">
    <div class="sheet">
      <h2>지도</h2>
      <p>미션 위치와 진행 상태를 확인할 수 있어요.</p>
      <canvas id="mapUiCanvas" width="520" height="420"></canvas>
      <div class="legend">
        <span><i class="dot" style="background:rgba(125,211,252,.95)"></i> 활성 미션</span>
        <span><i class="dot" style="background:rgba(255,152,84,.95)"></i> 해결됨</span>
        <span><i class="dot" style="background:rgba(255,255,255,.85)"></i> 내 위치</span>
      </div>
      <div class="divider"></div>
      <button class="ui wide" id="closeMap">닫기</button>
    </div>
  </div>

  <script>
    // Cloudflare Workers로 온라인 연동할 때 여기에 wss 주소를 넣어줘 (예: wss://your-domain.workers.dev)
    window.__ONLINE_WS_BASE__ = '';
  </script>

  <script>
  // file:// 로 실행하면 브라우저 보안 정책으로 에셋 로딩이 막힐 수 있어 안내만 표시
  (function(){
    try{
      const st = document.getElementById('lobbyStatus');
      if (!st) return;
      if (location.protocol === 'file:'){
        st.innerHTML = '※ 팁: 파일 더블클릭(file://)로는 에셋 로딩이 막힐 수 있어요. <b>로컬 서버</b>로 실행하세요. (예: <code>python -m http.server 8000</code>)';
      }
    }catch(_){ }
  })();
  </script>

  <!-- Embedded(coop) mode: parent가 이미 로비/룸 UI를 갖고 있으므로
       게임 내부 로비는 숨기고, bridge_init 레이스를 대비해 init 메시지를 버퍼링한다. -->
  <script>
  (function(){
    try{
      const sp = new URLSearchParams(location.search);
      if (sp.get('embed') !== '1') return;

      // In embed mode, keep a small status visible until we receive bridge_init.
      try{ const st=document.getElementById('lobbyStatus'); if(st) st.textContent='연결중...'; }catch(_){ }

      // In embed mode we don't want to show the internal lobby overlay at all.
      // The parent page already has a lobby + start button.
      try{ document.getElementById('lobby')?.classList?.add('hidden'); }catch(_){ }

      // Early handshake + buffering (init이 module 로딩 전에 도착할 수 있음)
      try{ window.parent?.postMessage({ type: 'bridge_ready' }, '*'); }catch(_){ }
      window.addEventListener('message', (e)=>{
        const d = e.data || {};
        if (d && typeof d === 'object' && d.type === 'bridge_init'){
          window.__PENDING_BRIDGE_INIT__ = d;
        }
      });
    }catch(_){ }
  })();
  </script>
  <!-- Pixel character data (generated from the user's 3-view sprite) -->
  <script>
  (function(){
    const url = 'assets/mathrabbit.mp3';
    let bgm = null;
    // Global audio preference comes from the lobby/room (localStorage: 'audio_enabled').
    // Default: enabled ('1'). If disabled ('0'), we must not play BGM.
    let muted = false;

    function prefEnabled(){
      try{ return (localStorage.getItem('audio_enabled') || '1') === '1'; }catch(_){ return true; }
    }

    function applyMuted(nextMuted){
      muted = !!nextMuted;
      try{
        if (bgm){
          bgm.volume = muted ? 0 : 0.35;
          if (muted) bgm.pause();
        }
      }catch(_){ }
      if (!muted) start();
    }

    function ensure(){
      if (bgm) return;
      try{
        bgm = new Audio(url);
        bgm.loop = true;
        bgm.preload = 'auto';
        bgm.volume = muted ? 0 : 0.35;
      }catch(_){ bgm = null; }
    }

    function start(){
      if (muted) return;
      ensure();
      if (!bgm) return;
      try{
        if (bgm.paused){
          const p = bgm.play();
          if (p && typeof p.catch === 'function') p.catch(()=>{});
        }
      }catch(_){ }
    }

    function pause(){
      try{ if(bgm) bgm.pause(); }catch(_){ }
    }

    const once = ()=>{ start(); };
    window.addEventListener('pointerdown', once, { once:true, passive:true });
    window.addEventListener('touchstart', once, { once:true, passive:true });
    window.addEventListener('mousedown', once, { once:true, passive:true });
    window.addEventListener('keydown', once, { once:true });

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) pause(); else start(); });
    window.addEventListener('pagehide', pause);

    // optional toggle hook
    window.__toggleBgmMuted__ = function(){
      applyMuted(!muted);
      return muted;
    };

    // Sync with global preference.
    try{ applyMuted(!prefEnabled()); }catch(_){ }

    // Listen for preference changes from parent.
    try{
      window.addEventListener('storage', (ev)=>{
        if (ev && ev.key === 'audio_enabled'){
          applyMuted(!prefEnabled());
        }
      });
    }catch(_){ }

    // Some browsers may not dispatch storage events into iframes reliably.
    // Parent can also broadcast via postMessage({type:'audio_pref', enabled:boolean}).
    try{
      window.addEventListener('message', (e)=>{
        const d = e?.data || {};
        if (!d || typeof d !== 'object') return;
        if (d.type === 'audio_pref' && typeof d.enabled === 'boolean'){
          applyMuted(!d.enabled);
        }
      });
    }catch(_){ }

    // Parent may call this directly via contentWindow.
    window.__setAudioEnabled__ = function(enabled){
      applyMuted(!enabled);
    };
  })();
  </script>
  <script src="assets_inline.js"></script>
  <script src="tokki_data.js"></script>
  <script src="game.js"></script>
</body>
</html>
