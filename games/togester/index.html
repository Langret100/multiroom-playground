<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ğŸ¹ íˆ¬ê²ŒìŠ¤í„° - í˜‘ë™ í”Œë«í¼ ê²Œì„</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Black+Han+Sans&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-family: 'Jua', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #lobby {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        #lobby.hidden {
            display: none;
        }
        
        .lobby-title {
            font-family: 'Black Han Sans', sans-serif;
            font-size: clamp(2rem, 8vw, 4rem);
            color: #fff;
            text-shadow: 4px 4px 0 #e94560, 8px 8px 0 rgba(0,0,0,0.2);
            margin-bottom: 10px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .lobby-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            margin-bottom: 30px;
        }
        
        .cat-parade {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .cat-preview {
            width: 50px;
            height: 55px;
            animation: parade 0.5s ease infinite alternate;
        }
        
        .cat-preview:nth-child(2) { animation-delay: 0.1s; }
        .cat-preview:nth-child(3) { animation-delay: 0.2s; }
        .cat-preview:nth-child(4) { animation-delay: 0.3s; }
        
        @keyframes parade {
            from { transform: translateY(0) rotate(-5deg); }
            to { transform: translateY(-10px) rotate(5deg); }
        }
        
        .input-group {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .input-group label {
            display: block;
            color: rgba(255,255,255,0.9);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-family: 'Jua', sans-serif;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-family: 'Black Han Sans', sans-serif;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .btn-create {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
        }
        
        .btn-join {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
        }
        
        .btn-guest {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            width: 100%;
            max-width: 280px;
        }
        
        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #gameHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .room-code {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .level-info {
            color: #ffd700;
            font-size: 1rem;
        }
        
        .death-count {
            color: #ff6b6b;
            font-size: 0.9rem;
            background: rgba(255,107,107,0.2);
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        #gameCanvas {
            flex: 1;
            width: 100%;
        }
        
        #playerList {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            padding: 10px;
            border-radius: 10px;
            z-index: 100;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            color: white;
            font-size: 0.85rem;
        }
        
        .player-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        #controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.75rem;
            text-align: center;
            z-index: 100;
            opacity: 0.8;
            max-width: 90%;
            white-space: nowrap;
        }
        
        #winScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        #winScreen.show {
            display: flex;
        }
        
        .win-text {
            font-family: 'Black Han Sans', sans-serif;
            font-size: clamp(2rem, 10vw, 5rem);
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
            animation: pulse 0.5s ease infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .firebase-config {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            max-width: 300px;
            width: 100%;
        }
        
        .firebase-config summary {
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .firebase-config input {
            width: 100%;
            padding: 8px 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            background: rgba(255,255,255,0.9);
        }
        
        .error-msg {
            color: #ff6b6b;
            background: rgba(255,107,107,0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            display: none;
        }
        
        .error-msg.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- ë¡œë¹„ í™”ë©´ -->
    <div id="lobby">
        <h1 class="lobby-title">ğŸ¹ íˆ¬ê²ŒìŠ¤í„°</h1>
        <p class="lobby-subtitle">ìµœëŒ€ 4ëª…ì´ í•¨ê»˜í•˜ëŠ” í˜‘ë™ í”Œë«í¼ ê²Œì„!</p>
        
        <div class="cat-parade">
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#ff6b6b"/>
                <circle cx="8" cy="10" r="6" fill="#ff6b6b"/>
                <circle cx="32" cy="10" r="6" fill="#ff6b6b"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#4ecdc4"/>
                <circle cx="8" cy="10" r="6" fill="#4ecdc4"/>
                <circle cx="32" cy="10" r="6" fill="#4ecdc4"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#ffe66d"/>
                <circle cx="8" cy="10" r="6" fill="#ffe66d"/>
                <circle cx="32" cy="10" r="6" fill="#ffe66d"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#a29bfe"/>
                <circle cx="8" cy="10" r="6" fill="#a29bfe"/>
                <circle cx="32" cy="10" r="6" fill="#a29bfe"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
        </div>
        
        <div class="input-group">
            <label>ë‹‰ë„¤ì„</label>
            <input type="text" id="playerName" placeholder="í–„ìŠ¤í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
        </div>
        
        <div class="input-group">
            <label>ë°© ì½”ë“œ (ì°¸ê°€ì‹œ)</label>
            <input type="text" id="roomCode" placeholder="ë°© ì½”ë“œ ì…ë ¥" maxlength="6" style="text-transform: uppercase;">
        </div>
        
        <div>
            <button class="btn btn-create" onclick="createRoom()">ğŸ  ë°© ë§Œë“¤ê¸°</button>
            <button class="btn btn-join" onclick="joinRoom()">ğŸšª ì°¸ê°€í•˜ê¸°</button>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="btn btn-guest" onclick="startGuestMode()">ğŸ® í˜¼ì ì—°ìŠµí•˜ê¸°</button>
        </div>
        
        <div id="errorMsg" class="error-msg"></div>
    </div>
    
    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameContainer" style="display:none;">
        <div id="gameHeader">
            <span class="room-code" id="displayRoomCode">ë°©: ----</span>
            <span class="level-info" id="levelInfo">ë ˆë²¨ 1</span>
            <span class="death-count" id="deathCount">ğŸ’€ 0</span>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div id="playerList"></div>
        
        <div id="controls-hint">
            ì¢Œ/ìš° í´ë¦­: ì´ë™ | ì–‘ìª½ í´ë¦­: ì í”„ | ë°•ìŠ¤ë¥¼ ë°€ì–´ì„œ ë²„íŠ¼ì„ ëˆŒëŸ¬ìš”!
        </div>
    </div>
    
    <!-- ìŠ¹ë¦¬ í™”ë©´ -->
    <div id="winScreen">
        <div class="win-text">ğŸ‰ ë ˆë²¨ í´ë¦¬ì–´! ğŸ‰</div>
        <div id="autoNextHint" style="color: #aaa; margin-top: 15px; font-size: 0.9rem;">ì ì‹œ í›„ ë‹¤ìŒ ë ˆë²¨ë¡œ...</div>
    </div>

    <!-- ë°°ê²½ìŒì•… (ê²Œì„ ì§„í–‰ ì¤‘ ë°˜ë³µ ì¬ìƒ) -->
    <audio id="bgm" src="togestermusic.mp3" loop preload="auto"></audio>
<script>
        // ==================== ì„¤ì • ====================
        // Firebase ì˜ì¡´ì„± ì œê±° (Colyseus/ë¶€ëª¨ ë¸Œë¦¿ì§€ë¡œ ë™ê¸°í™”)
        const EMBED = new URLSearchParams(location.search).get('embed') === '1';
        function bridgeSend(type, payload){
            if (!EMBED) return;
            try { window.parent && window.parent.postMessage({ type, ...payload }, '*'); } catch(e){}
        }

        // ==================== ê²Œì„ ìƒíƒœ ====================
        let db = null;
        let roomRef = null;
        let playerId = null;
        let roomId = null;
        let isHost = false;
        let isGuestMode = false;
        let currentLevel = 1;
        
        const HAMSTER_COLORS = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#a29bfe'];
        
        let localPlayer = {
            x: 100,
            y: 300,
            vx: 0,
            vy: 0,
            color: HAMSTER_COLORS[0],
            name: 'í–„ì°Œ',
            onGround: false,
            onButton: false,
            isDead: false
        };
        
        let players = {};
        let smoothedPlayers = {};
        // ë„¤íŠ¸ì›Œí¬ ë³´ê°„ìš© íˆìŠ¤í† ë¦¬ ë²„í¼ (ìƒëŒ€ ì›€ì§ì„ ëŠê¹€ ì™„í™”)
        let remoteHistory = {}; // { sid: [{t,x,y,vx,vy,isDead,color,name}, ...] }
        const NET_INTERP_DELAY_MS = 120; // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ë³´ê°„ (ì§€í„°/ëŠê¹€ ì™„í™”)
        const NET_MAX_HISTORY_MS = 2000;
        let gameObjects = [];
        let canvas, ctx;
        let cameraX = 0;
        let deathCount = 0; // í˜„ì¬ ë ˆë²¨ ì‚¬ë§ íšŸìˆ˜
        
        // í„°ì¹˜ ìƒíƒœ
        let touches = {};
        let moveDirection = 0; // -1: ì™¼ìª½, 0: ì •ì§€, 1: ì˜¤ë¥¸ìª½
        
        // ==================== ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ====================
        let audioCtx = null;

        // ë°°ê²½ìŒì•… (ì²¨ë¶€ mp3) - ê²Œì„ ì§„í–‰ ì¤‘ ë°˜ë³µ ì¬ìƒ
        let bgmEl = null;
        let bgmWanted = false;

        function initBGM() {
            if (!bgmEl) bgmEl = document.getElementById('bgm');
            if (bgmEl) {
                bgmEl.loop = true;
                bgmEl.preload = 'auto';
                // ê¸°ë³¸ ë³¼ë¥¨ (ë„ˆë¬´ í¬ì§€ ì•Šê²Œ)
                if (typeof bgmEl.volume === 'number') bgmEl.volume = 0.5;
            }
        }

        async function startBGM() {
            initBGM();
            if (!bgmEl) return;
            bgmWanted = true;
            try {
                await bgmEl.play();
            } catch (e) {
                // ìë™ì¬ìƒ ì œí•œ: ì²« ì…ë ¥ ì‹œ ì¬ì‹œë„
            }
        }

        function stopBGM() {
            bgmWanted = false;
            if (!bgmEl) return;
            try {
                bgmEl.pause();
                bgmEl.currentTime = 0;
            } catch (e) {}
        }

        // ì‚¬ìš©ì ì…ë ¥ì´ ë°œìƒí•˜ë©´ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸/ë°°ê²½ìŒì•… ì¬ì‹œë„ (ìë™ì¬ìƒ ì œí•œ ëŒ€ì‘)
        (function attachBGMGestureRetry(){
            const tryStart = async () => {
                initAudio();
                initBGM();
                if (!bgmEl) return;
                if (!bgmWanted) return;
                if (!bgmEl.paused) return;
                try { await bgmEl.play(); } catch (e) { return; }
            };
            document.addEventListener('pointerdown', tryStart, { passive: true });
            document.addEventListener('touchstart', tryStart, { passive: true });
            document.addEventListener('keydown', tryStart);
        })();
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        function playTone(frequency, duration, type = 'square', volume = 0.3, slide = 0) {
            if (!audioCtx) return;
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            
            if (slide !== 0) {
                oscillator.frequency.linearRampToValueAtTime(frequency + slide, audioCtx.currentTime + duration);
            }
            
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration);
        }
        
        // ì í”„ ì†Œë¦¬ - ê·€ì—¬ìš´ "ë¿…!"
        function sfxJump() {
            initAudio();
            playTone(400, 0.1, 'sine', 0.2, 400);
        }
        
        // ë²„íŠ¼ ëˆ„ë¦„ - ë°ì€ "ë”©!"
        function sfxButton() {
            initAudio();
            playTone(880, 0.1, 'sine', 0.2);
            setTimeout(() => playTone(1100, 0.15, 'sine', 0.15), 50);
        }
        
        // ë¬¸ ì—´ë¦¼ - ìƒìŠ¹ ë©œë¡œë””
        function sfxDoorOpen() {
            initAudio();
            playTone(440, 0.1, 'triangle', 0.15);
            setTimeout(() => playTone(550, 0.1, 'triangle', 0.15), 80);
            setTimeout(() => playTone(660, 0.15, 'triangle', 0.15), 160);
        }
        
        // ì‚¬ë§ - ìŠ¬í”ˆ í•˜ê°•ìŒ
        function sfxDeath() {
            initAudio();
            playTone(400, 0.15, 'square', 0.2, -200);
            setTimeout(() => playTone(200, 0.3, 'square', 0.15, -100), 150);
        }
        
        // ë ˆë²¨ í´ë¦¬ì–´ - ì¶•í•˜ ë©œë¡œë””
        function sfxLevelClear() {
            initAudio();
            const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            notes.forEach((note, i) => {
                setTimeout(() => playTone(note, 0.15, 'sine', 0.2), i * 100);
            });
        }
        
        // ê²Œì„ í´ë¦¬ì–´ - ê¸´ ì¶•í•˜ ë©œë¡œë””
        function sfxGameClear() {
            initAudio();
            const notes = [523, 587, 659, 698, 784, 880, 988, 1047]; // C major scale
            notes.forEach((note, i) => {
                setTimeout(() => playTone(note, 0.2, 'sine', 0.25), i * 120);
            });
            setTimeout(() => {
                playTone(1047, 0.4, 'sine', 0.3);
                playTone(1319, 0.4, 'sine', 0.2);
                playTone(1568, 0.4, 'sine', 0.2);
            }, notes.length * 120);
        }
        
        // ê±·ê¸° ì†Œë¦¬ (ì‘ì€ ë°œì†Œë¦¬)
        let lastStepTime = 0;
        function sfxStep() {
            const now = Date.now();
            if (now - lastStepTime < 200) return; // 200msë§ˆë‹¤ í•œ ë²ˆ
            lastStepTime = now;
            initAudio();
            playTone(100 + Math.random() * 50, 0.05, 'sine', 0.05);
        }
        
        // ë°•ìŠ¤ ë°€ê¸° ì†Œë¦¬
        let lastPushTime = 0;
        function sfxPush() {
            const now = Date.now();
            if (now - lastPushTime < 150) return;
            lastPushTime = now;
            initAudio();
            playTone(150, 0.08, 'square', 0.1);
        }
        
        
        // ==================== ë ˆë²¨ ë°ì´í„° ====================
        // ì í”„: ì•½ 150px ë†’ì´, 200px ê±°ë¦¬
        const LEVELS = [
            // ===== 1-5: íŠœí† ë¦¬ì–¼ =====
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 600, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 800, height: 50, color: '#2d3436' }],
                buttons: [], doors: [], spikes: [], boxes: [],
                message: "ì´ë™: ì¢Œìš° í´ë¦­"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 500, y: 250, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 350, y: 300, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [], doors: [], spikes: [], boxes: [],
                message: "ì í”„: ì–‘ìª½ ë™ì‹œ í´ë¦­"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 550, y: 250, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 700, height: 50, color: '#2d3436' },
                    { x: 450, y: 300, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [], doors: [], spikes: [],
                boxes: [{ x: 300, y: 360, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ë¥¼ ë°€ì–´ì„œ ë°œíŒìœ¼ë¡œ!"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 600, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 800, height: 50, color: '#2d3436' }],
                buttons: [{ x: 250, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 450, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 150, y: 360, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ë¡œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬¸ì„ ì—´ì–´!"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 600, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 800, height: 50, color: '#2d3436' }],
                buttons: [], doors: [],
                spikes: [{ x: 300, y: 380, width: 60, height: 20 }],
                boxes: [{ x: 180, y: 360, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ ìœ„ë¡œ ì í”„í•´ì„œ ìŠ¤íŒŒì´í¬ë¥¼ ë„˜ì–´!"
            },

            // ===== 6-10: ê¸°ë³¸ í¼ì¦ (ì„ íƒê³¼ ìˆœì„œ) =====
            // 6: ë°•ìŠ¤ ìœ„ì¹˜ ì„ íƒ - ìŠ¤íŒŒì´í¬ë¥¼ ë„˜ì„ê¹Œ ë²„íŠ¼ì„ ëˆ„ë¥¼ê¹Œ
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 800, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1000, height: 50, color: '#2d3436' }],
                buttons: [{ x: 600, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 350, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [{ x: 480, y: 380, width: 60, height: 20 }],
                boxes: [{ x: 200, y: 360, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ë¡œ ë²„íŠ¼? ìŠ¤íŒŒì´í¬? ìˆœì„œê°€ ì¤‘ìš”!"
            },
            // 7: ë‘ ê°œì˜ ìŠ¤íŒŒì´í¬ - ë°•ìŠ¤ í•˜ë‚˜ë¡œ ì í”„ì í”„
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 700, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 900, height: 50, color: '#2d3436' }],
                buttons: [], doors: [],
                spikes: [
                    { x: 280, y: 380, width: 60, height: 20 },
                    { x: 450, y: 380, width: 60, height: 20 }
                ],
                boxes: [{ x: 150, y: 360, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ í•˜ë‚˜ë¡œ ìŠ¤íŒŒì´í¬ ë‘ ê°œë¥¼!"
            },
            // 8: ë°•ìŠ¤ 2ê°œ ì—­í•  ë¶„ë‹´
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 850, y: 250, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 700, height: 50, color: '#2d3436' },
                    { x: 750, y: 300, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 350, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 600, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 500, y: 360, width: 40, height: 40 }
                ],
                message: "í•˜ë‚˜ëŠ” ë²„íŠ¼ì—, í•˜ë‚˜ëŠ” ë°œíŒìœ¼ë¡œ!"
            },
            // 9: ë˜ëŒì•„ì˜¤ê¸°
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 100, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 400, height: 50, color: '#2d3436' },
                    { x: 500, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 0, y: 250, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 600, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 430, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 200, y: 360, width: 40, height: 40 }],
                message: "ì˜¤ë¥¸ìª½ ê°”ë‹¤ ëŒì•„ì™€ì•¼ í•´!"
            },
            // 10: ë‘ ê°œì˜ ë¬¸
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 950, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1150, height: 50, color: '#2d3436' }],
                buttons: [
                    { x: 250, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 550, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 400, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 700, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 480, y: 360, width: 40, height: 40 }
                ],
                message: "ë°•ìŠ¤ 2ê°œë¡œ ë¬¸ 2ê°œ!"
            },

            // ===== 11-15: ì¤‘ê¸‰ (ë³µí•© í¼ì¦) =====
            // 11: í•¨ì • êµ¬ë© - ë°•ìŠ¤ ë–¨ì–´ëœ¨ë¦¬ë©´ ë
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 750, y: 350, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 280, height: 50, color: '#2d3436' },
                    { x: 360, y: 400, width: 550, height: 50, color: '#2d3436' },
                ],
                buttons: [{ x: 500, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 630, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 150, y: 360, width: 40, height: 40 }],
                message: "êµ¬ë©ì— ë°•ìŠ¤ ë¹ ëœ¨ë¦¬ì§€ ë§ˆ!"
            },
            // 12: ìŠ¤íŒŒì´í¬ + ë¬¸ ì¡°í•©
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 900, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1100, height: 50, color: '#2d3436' }],
                buttons: [{ x: 300, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 500, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [
                    { x: 620, y: 380, width: 60, height: 20 },
                    { x: 750, y: 380, width: 60, height: 20 }
                ],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 550, y: 360, width: 40, height: 40 }
                ],
                message: "ë²„íŠ¼ìš© + ìŠ¤íŒŒì´í¬ìš©!"
            },
            // 13: ë°•ìŠ¤ ë‹¤ë¦¬
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 650, y: 350, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 250, height: 50, color: '#2d3436' },
                    { x: 400, y: 400, width: 450, height: 50, color: '#2d3436' },
                ],
                buttons: [], doors: [],
                spikes: [{ x: 270, y: 500, width: 110, height: 20 }],
                boxes: [
                    { x: 100, y: 360, width: 40, height: 40 },
                    { x: 160, y: 360, width: 40, height: 40 }
                ],
                message: "ë°•ìŠ¤ë¡œ ë‹¤ë¦¬ë¥¼ ë§Œë“¤ì–´!"
            },
            // 14: ì¤‘ê°„ ë°œíŒ
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 700, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 400, height: 50, color: '#2d3436' },
                    { x: 250, y: 480, width: 150, height: 20, color: '#636e72' },
                    { x: 500, y: 360, width: 150, height: 20, color: '#636e72' },
                    { x: 600, y: 250, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 300, y: 460, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 430, y: 260, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 150, y: 560, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ë¥¼ ìœ„ì¸µìœ¼ë¡œ ì˜¬ë ¤!"
            },
            // 15: ë°•ìŠ¤ 1ê°œë¡œ ë¬¸ 2ê°œ (ìˆœì„œ í¼ì¦)
            {
                spawn: { x: 450, y: 350 },
                goal: { x: 450, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 350, y: 400, width: 200, height: 50, color: '#2d3436' },
                    { x: 50, y: 400, width: 150, height: 50, color: '#2d3436' },
                    { x: 700, y: 400, width: 150, height: 50, color: '#2d3436' },
                    { x: 350, y: 200, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 80, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 750, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 250, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 610, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [{ x: 430, y: 360, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ 1ê°œë¡œ ë¬¸ 2ê°œ! ì–´ëŠ ìª½ ë¨¼ì €?"
            },

            // ===== 16-20: ê³ ê¸‰ (ë³µì¡í•œ êµ¬ì¡°) =====
            // 16: 3ë‹¨ ì í”„
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 700, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 350, height: 50, color: '#2d3436' },
                    { x: 200, y: 480, width: 150, height: 20, color: '#636e72' },
                    { x: 400, y: 360, width: 150, height: 20, color: '#636e72' },
                    { x: 600, y: 240, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 650, y: 220, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 530, y: 140, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 100, y: 560, width: 40, height: 40 }],
                message: "ë°•ìŠ¤ë¥¼ ëê¹Œì§€ ë°€ì–´ ì˜¬ë ¤!"
            },
            // 17: 3ê°œì˜ ë¬¸
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 1150, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1350, height: 50, color: '#2d3436' }],
                buttons: [
                    { x: 200, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 500, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false },
                    { x: 800, y: 380, width: 60, height: 20, color: '#a29bfe', doorId: 2, pressed: false }
                ],
                doors: [
                    { x: 350, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 650, y: 300, width: 40, height: 100, color: '#00cec9', open: false },
                    { x: 950, y: 300, width: 40, height: 100, color: '#a29bfe', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 420, y: 360, width: 40, height: 40 },
                    { x: 720, y: 360, width: 40, height: 40 }
                ],
                message: "ë°•ìŠ¤ 2ê°œë¡œ ë¬¸ 3ê°œ!"
            },
            // 18: ë³µí•© ì§€í˜•
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 950, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 380, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 760, y: 400, width: 350, height: 50, color: '#2d3436' },
                    { x: 850, y: 250, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 500, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 690, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [
                    { x: 310, y: 500, width: 60, height: 20 },
                    { x: 850, y: 380, width: 60, height: 20 }
                ],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 800, y: 360, width: 40, height: 40 }
                ],
                message: "êµ¬ë© + ìŠ¤íŒŒì´í¬ + ë¬¸!"
            },
            // 19: ì—­ë°©í–¥ ì§„í–‰
            {
                spawn: { x: 900, y: 350 },
                goal: { x: 100, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 400, height: 50, color: '#2d3436' },
                    { x: 500, y: 400, width: 550, height: 50, color: '#2d3436' },
                    { x: 0, y: 250, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 700, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 250, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 430, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 50, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 800, y: 360, width: 40, height: 40 },
                    { x: 550, y: 360, width: 40, height: 40 }
                ],
                message: "ì˜¤ë¥¸ìª½ì—ì„œ ì‹œì‘! ì™¼ìª½ìœ¼ë¡œ!"
            },
            // 20: íƒ€ì›Œ ìŒ“ê¸°
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 350, y: 100, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 600, height: 50, color: '#2d3436' },
                    { x: 300, y: 150, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 100, y: 580, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 250, y: 250, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [
                    { x: 200, y: 560, width: 40, height: 40 },
                    { x: 260, y: 560, width: 40, height: 40 },
                    { x: 320, y: 560, width: 40, height: 40 }
                ],
                message: "ë°•ìŠ¤ë¥¼ ìŒ“ì•„ íƒ‘ì„ ë§Œë“¤ì–´!"
            },

            // ===== 21-25: ë§ˆìŠ¤í„° =====
            // 21: ì–‘ê°ˆë˜ + ì¤‘ì•™ ëª©í‘œ
            {
                spawn: { x: 450, y: 550 },
                goal: { x: 450, y: 100, width: 80, height: 50 },
                platforms: [
                    { x: 350, y: 600, width: 200, height: 50, color: '#2d3436' },
                    { x: 50, y: 450, width: 200, height: 50, color: '#2d3436' },
                    { x: 650, y: 450, width: 200, height: 50, color: '#2d3436' },
                    { x: 50, y: 300, width: 150, height: 20, color: '#636e72' },
                    { x: 700, y: 300, width: 150, height: 20, color: '#636e72' },
                    { x: 350, y: 150, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 80, y: 280, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 750, y: 280, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 280, y: 50, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 580, y: 50, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 400, y: 560, width: 40, height: 40 },
                    { x: 460, y: 560, width: 40, height: 40 }
                ],
                message: "ì–‘ìª½ì— ë°•ìŠ¤ë¥¼ ë°°ì¹˜!"
            },
            // 22: ì—°ì‡„ ìš´ë°˜
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 1050, y: 350, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 280, height: 50, color: '#2d3436' },
                    { x: 360, y: 400, width: 200, height: 50, color: '#2d3436' },
                    { x: 640, y: 400, width: 550, height: 50, color: '#2d3436' },
                ],
                buttons: [
                    { x: 150, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 420, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 290, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 570, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [{ x: 800, y: 380, width: 100, height: 20 }],
                boxes: [
                    { x: 400, y: 360, width: 40, height: 40 },
                    { x: 700, y: 360, width: 40, height: 40 }
                ],
                message: "ë°•ìŠ¤ë¥¼ ìˆœì„œëŒ€ë¡œ ì˜®ê²¨!"
            },
            // 23: 4ì¸µ íƒ‘
            {
                spawn: { x: 100, y: 700 },
                goal: { x: 700, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 750, width: 350, height: 50, color: '#2d3436' },
                    { x: 200, y: 620, width: 150, height: 20, color: '#636e72' },
                    { x: 400, y: 490, width: 150, height: 20, color: '#636e72' },
                    { x: 550, y: 360, width: 150, height: 20, color: '#636e72' },
                    { x: 600, y: 230, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 100, y: 730, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 580, y: 340, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 130, y: 650, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 530, y: 130, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 200, y: 710, width: 40, height: 40 },
                    { x: 450, y: 450, width: 40, height: 40 }
                ],
                message: "ì¸µì¸µì´ ë°•ìŠ¤ë¥¼ ì˜¬ë ¤!"
            },
            // 24: ìµœí›„ì˜ ì‹œí—˜
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 1000, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 280, height: 50, color: '#2d3436' },
                    { x: 360, y: 400, width: 250, height: 50, color: '#2d3436' },
                    { x: 690, y: 400, width: 450, height: 50, color: '#2d3436' },
                    { x: 350, y: 280, width: 150, height: 20, color: '#636e72' },
                    { x: 650, y: 280, width: 150, height: 20, color: '#636e72' },
                    { x: 900, y: 200, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 150, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 450, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false },
                    { x: 400, y: 260, width: 60, height: 20, color: '#a29bfe', doorId: 2, pressed: false }
                ],
                doors: [
                    { x: 290, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 620, y: 300, width: 40, height: 100, color: '#00cec9', open: false },
                    { x: 830, y: 100, width: 40, height: 100, color: '#a29bfe', open: false }
                ],
                spikes: [{ x: 750, y: 380, width: 60, height: 20 }],
                boxes: [
                    { x: 400, y: 360, width: 40, height: 40 },
                    { x: 700, y: 260, width: 40, height: 40 }
                ],
                message: "ë°•ìŠ¤ 2ê°œë¡œ ë¬¸ 3ê°œ! ìˆœì„œê°€ í•µì‹¬!"
            },
            // 25: ìµœì¢… ë³´ìŠ¤
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 950, y: 100, width: 100, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 350, height: 50, color: '#2d3436' },
                    { x: 430, y: 600, width: 300, height: 50, color: '#2d3436' },
                    { x: 810, y: 600, width: 300, height: 50, color: '#2d3436' },
                    { x: 200, y: 480, width: 150, height: 20, color: '#636e72' },
                    { x: 500, y: 380, width: 150, height: 20, color: '#636e72' },
                    { x: 750, y: 280, width: 150, height: 20, color: '#636e72' },
                    { x: 850, y: 150, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 150, y: 580, width: 60, height: 20, color: '#ff6b6b', doorId: 0, pressed: false },
                    { x: 530, y: 580, width: 60, height: 20, color: '#4ecdc4', doorId: 1, pressed: false },
                    { x: 900, y: 580, width: 60, height: 20, color: '#ffe66d', doorId: 2, pressed: false },
                    { x: 550, y: 360, width: 60, height: 20, color: '#a29bfe', doorId: 3, pressed: false }
                ],
                doors: [
                    { x: 360, y: 500, width: 40, height: 100, color: '#ff6b6b', open: false },
                    { x: 740, y: 500, width: 40, height: 100, color: '#4ecdc4', open: false },
                    { x: 680, y: 180, width: 40, height: 100, color: '#ffe66d', open: false },
                    { x: 800, y: 50, width: 40, height: 100, color: '#a29bfe', open: false }
                ],
                spikes: [
                    { x: 250, y: 460, width: 60, height: 20 },
                    { x: 600, y: 580, width: 60, height: 20 }
                ],
                boxes: [
                    { x: 250, y: 560, width: 40, height: 40 },
                    { x: 480, y: 560, width: 40, height: 40 },
                    { x: 800, y: 260, width: 40, height: 40 }
                ],
                message: "ğŸŠ ìµœì¢…! ë°•ìŠ¤ 3ê°œë¡œ ë¬¸ 4ê°œ! ğŸŠ"
            }
        ];
        // ==================== ì—ëŸ¬ í‘œì‹œ ====================
        function showError(msg, isError = true) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.className = 'error-msg show';
            el.style.color = isError ? '#ff6b6b' : '#00b894';
            el.style.background = isError ? 'rgba(255,107,107,0.2)' : 'rgba(0,184,148,0.2)';
            setTimeout(() => el.classList.remove('show'), 3000);
        }
        
        // ==================== ë°© ê´€ë¦¬ ====================
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ==================== ì„ë² ë“œ ëª¨ë“œ(Colyseus ë¸Œë¦¿ì§€) ====================
        function startEmbedded(init){
            isGuestMode = false;
            isHost = !!init.isHost;
            roomId = String(init.roomCode || 'ROOM');
            playerId = String(init.sessionId || ('p_' + Date.now()));
            localPlayer.name = String(init.nick || 'í–„ì°Œ').slice(0, 16);
            const seat = typeof init.seat === 'number' ? init.seat : 0;
            localPlayer.color = HAMSTER_COLORS[seat % HAMSTER_COLORS.length];
            currentLevel = 1;
            try{ tgEnded = false; }catch(e){}
            startGame();
            // ì²« ìƒíƒœ ì „ì†¡
            bridgeSendState(true);
        }

        // createRoom()/joinRoom()/Firebase ë¡œì§ ì œê±°: ì™¸ë¶€ ë¡œë¹„(Colyseus)ì—ì„œ ë°©/ì…ì¥ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        
        function startGuestMode() {
            const name = document.getElementById('playerName').value.trim() || 'í–„ì°Œ';
            
            isGuestMode = true;
            isHost = true;
            roomId = 'GUEST';
            playerId = 'guest_player';
            
            localPlayer.name = name;
            localPlayer.color = HAMSTER_COLORS[0];
            localPlayer.x = LEVELS[0].spawn.x;
            localPlayer.y = LEVELS[0].spawn.y;
            
            startGame();
        }
        
        function updatePlayerList() {
            const container = document.getElementById('playerList');
            let html = `<div class="player-item">
                <div class="player-dot" style="background:${localPlayer.color}"></div>
                <span>${localPlayer.name} ${isGuestMode ? '(ì—°ìŠµì¤‘)' : '(ë‚˜)'}</span>
            </div>`;
            
            if (!isGuestMode) {
                Object.values(players).forEach(p => {
                    html += `<div class="player-item">
                        <div class="player-dot" style="background:${p.color}"></div>
                        <span>${p.name}</span>
                    </div>`;
                });
            }
            
            container.innerHTML = html;
        }
        
        // ==================== ê²Œì„ ì‹œì‘ ====================
        function startGame() {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameContainer').style.display = 'flex';
            document.getElementById('displayRoomCode').textContent = isGuestMode ? 'ğŸ® ì—°ìŠµ ëª¨ë“œ' : 'ë°©: ' + roomId;
            
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // ì˜¤ë””ì˜¤ ì´ˆê¸°í™”
            initAudio();
            // ë°°ê²½ìŒì•… ì‹œì‘ (ìë™ì¬ìƒ ì œí•œ ì‹œ ì²« ì…ë ¥ì—ì„œ ì¬ì‹œë„)
            startBGM();
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            loadLevel(currentLevel);
            setupControls();
            updatePlayerList();
            gameLoop();
        }
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        function loadLevel(levelNum) {
            const level = LEVELS[levelNum - 1];
            if (!level) {
                // ëª¨ë“  ë ˆë²¨ í´ë¦¬ì–´
                document.getElementById('winScreen').querySelector('.win-text').textContent = 'ğŸŠ ê²Œì„ í´ë¦¬ì–´! ğŸŠ';
                document.getElementById('autoNextHint').style.display = 'none';
                document.getElementById('winScreen').classList.add('show');
                sfxGameClear();
                // ë©€í‹° ì„ë² ë“œ: ì„±ê³µ -> ë¶€ëª¨/ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡ (ìë™ ëŒ€ê¸°ì‹¤ ë³µê·€)
                bridgeSendOver(true, "game_clear");
                return;
            }
            
            document.getElementById('autoNextHint').style.display = 'block';
            document.getElementById('winScreen').querySelector('.win-text').textContent = 'ğŸ‰ ë ˆë²¨ í´ë¦¬ì–´! ğŸ‰';
            let levelMessage = level.message;
            if (isGuestMode && level.buttons.length > 0) {
                levelMessage = "ë°•ìŠ¤ë¥¼ ë°€ì–´ì„œ ë²„íŠ¼ì„ ëˆŒëŸ¬ìš”!";
            }
            document.getElementById('levelInfo').textContent = `ë ˆë²¨ ${levelNum} - ${levelMessage}`;
            document.getElementById('winScreen').classList.remove('show');
            
            // ê²Œì„ ì˜¤ë¸Œì íŠ¸ ì´ˆê¸°í™”
            gameObjects = {
                platforms: [...level.platforms],
                buttons: level.buttons.map(b => ({...b, pressed: false})),
                doors: level.doors.map(d => ({...d, open: false})),
                spikes: [...level.spikes],
                goal: {...level.goal},
                boxes: (level.boxes || []).map(b => ({...b, vx: 0, vy: 0}))
            };
            
            // í”Œë ˆì´ì–´ ìœ„ì¹˜ ì´ˆê¸°í™”
            const colorIndex = HAMSTER_COLORS.indexOf(localPlayer.color);
            localPlayer.x = level.spawn.x + (colorIndex * 50);
            localPlayer.y = level.spawn.y;
            localPlayer.vx = 0;
            localPlayer.vy = 0;
            localPlayer.isDead = false;
            
            // ë„¤íŠ¸ì›Œí¬(ë¸Œë¦¿ì§€)ë¡œ ì´ˆê¸° ìœ„ì¹˜ ì „ì†¡
            bridgeSendState(true);

cameraX = 0;
        }
        
        function nextLevel() {
            if (isGuestMode) {
                currentLevel++;
                loadLevel(currentLevel);
            } else if (isHost) {
                currentLevel++;
                bridgeSend("tg_level", { level: currentLevel });
                loadLevel(currentLevel);
            }
        }
        
        // ==================== í„°ì¹˜ ì»¨íŠ¸ë¡¤ ====================
        function setupControls() {
            // í„°ì¹˜ ì‹œì‘
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                
                for (let touch of e.changedTouches) {
                    touches[touch.identifier] = {
                        x: touch.clientX,
                        y: touch.clientY,
                        startX: touch.clientX
                    };
                }
                
                // ë‘ ê°œ ì´ìƒ í„°ì¹˜ = ì í”„
                if (Object.keys(touches).length >= 2) {
                    if (localPlayer.onGround) {
                        localPlayer.vy = -15;
                        localPlayer.onGround = false;
                        sfxJump();
                    }
                } else {
                    // ë‹¨ì¼ í„°ì¹˜ = ì´ë™ ë°©í–¥ ê²°ì •
                    updateMoveDirection();
                }
            });
            
            // í„°ì¹˜ ì´ë™
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                for (let touch of e.changedTouches) {
                    if (touches[touch.identifier]) {
                        touches[touch.identifier].x = touch.clientX;
                        touches[touch.identifier].y = touch.clientY;
                    }
                }
                
                if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            // í„°ì¹˜ ì¢…ë£Œ
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                
                for (let touch of e.changedTouches) {
                    delete touches[touch.identifier];
                }
                
                if (Object.keys(touches).length === 0) {
                    moveDirection = 0;
                } else if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                for (let touch of e.changedTouches) {
                    delete touches[touch.identifier];
                }
                if (Object.keys(touches).length === 0) {
                    moveDirection = 0;
                }
            });
            
            // ë§ˆìš°ìŠ¤ ì»¨íŠ¸ë¡¤ (ë°ìŠ¤í¬í†±) - í„°ì¹˜ì™€ ì™„ì „íˆ ë™ì¼í•œ ë°©ì‹
            // ì¢Œí´ë¦­ = ì†ê°€ë½1, ìš°í´ë¦­ = ì†ê°€ë½2
            canvas.addEventListener('mousedown', (e) => {
                e.preventDefault();
                initAudio();
                
                if (e.button === 0) { // ì™¼ìª½ í´ë¦­ = ì†ê°€ë½ 1
                    touches['mouseLeft'] = { x: e.clientX, y: e.clientY };
                } else if (e.button === 2) { // ì˜¤ë¥¸ìª½ í´ë¦­ = ì†ê°€ë½ 2
                    touches['mouseRight'] = { x: e.clientX, y: e.clientY };
                }
                
                // ë‘ ê°œ ì´ìƒ = ì í”„ (í„°ì¹˜ì™€ ë™ì¼)
                if (Object.keys(touches).length >= 2) {
                    if (localPlayer.onGround) {
                        localPlayer.vy = -15;
                        localPlayer.onGround = false;
                        sfxJump();
                    }
                } else {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (touches['mouseLeft']) {
                    touches['mouseLeft'] = { x: e.clientX, y: e.clientY };
                }
                if (touches['mouseRight']) {
                    touches['mouseRight'] = { x: e.clientX, y: e.clientY };
                }
                
                if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('mouseup', (e) => {
                if (e.button === 0) {
                    delete touches['mouseLeft'];
                } else if (e.button === 2) {
                    delete touches['mouseRight'];
                }
                
                if (Object.keys(touches).length === 0) {
                    moveDirection = 0;
                } else if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                delete touches['mouseLeft'];
                delete touches['mouseRight'];
                moveDirection = 0;
            });
            
            // ìš°í´ë¦­ ë©”ë‰´ ë¹„í™œì„±í™”
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤ë„ ìœ ì§€ (ì„ íƒì  ì‚¬ìš©)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') moveDirection = -1;
                if (e.key === 'ArrowRight' || e.key === 'd') moveDirection = 1;
                if ((e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') && localPlayer.onGround) {
                    localPlayer.vy = -15;
                    localPlayer.onGround = false;
                    sfxJump();
                }
            });
            
            document.addEventListener('keyup', (e) => {
                if ((e.key === 'ArrowLeft' || e.key === 'a') && moveDirection === -1) moveDirection = 0;
                if ((e.key === 'ArrowRight' || e.key === 'd') && moveDirection === 1) moveDirection = 0;
            });
        }
        
        function updateMoveDirection() {
            const touchList = Object.values(touches);
            if (touchList.length === 0) {
                moveDirection = 0;
                return;
            }
            
            const touch = touchList[0];
            const screenCenter = window.innerWidth / 2;
            
            // í™”ë©´ ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ë°©í–¥ ê²°ì •
            if (touch.x < screenCenter) {
                moveDirection = -1;
            } else {
                moveDirection = 1;
            }
        }
        
        // ==================== ê²Œì„ ë¬¼ë¦¬ ====================
        function updatePhysics() {
            // ì´ë™
            const speed = 5;
            localPlayer.vx = moveDirection * speed;
            
            // ê±·ê¸° íš¨ê³¼ìŒ (ë•…ì—ì„œ ì´ë™ ì¤‘ì¼ ë•Œë§Œ)
            if (moveDirection !== 0 && localPlayer.onGround) {
                sfxStep();
            }
            
            // ì¤‘ë ¥
            localPlayer.vy += 0.6;
            if (localPlayer.vy > 15) localPlayer.vy = 15;
            
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            localPlayer.x += localPlayer.vx;
            localPlayer.y += localPlayer.vy;
            
            // í”Œë«í¼ ì¶©ëŒ
            localPlayer.onGround = false;
            
            for (let platform of gameObjects.platforms) {
                if (checkCollision(localPlayer, platform)) {
                    resolveCollision(localPlayer, platform);
                }
            }
            
            // ë‹«íŒ ë¬¸ê³¼ ì¶©ëŒ
            for (let door of gameObjects.doors) {
                if (!door.open && checkCollision(localPlayer, door)) {
                    resolveCollision(localPlayer, door);
                }
            }
            
            // ë°•ìŠ¤ ë¬¼ë¦¬
            for (let box of gameObjects.boxes) {
                // ë°•ìŠ¤ ì¤‘ë ¥
                box.vy += 0.6;
                if (box.vy > 15) box.vy = 15;
                
                // ë°•ìŠ¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                box.x += box.vx;
                box.y += box.vy;
                box.vx *= 0.8; // ë§ˆì°°
                
                // ë°•ìŠ¤-í”Œë«í¼ ì¶©ëŒ
                for (let platform of gameObjects.platforms) {
                    if (checkBoxCollision(box, platform)) {
                        resolveBoxCollision(box, platform);
                    }
                }
                
                // ë°•ìŠ¤-ë¬¸ ì¶©ëŒ
                for (let door of gameObjects.doors) {
                    if (!door.open && checkBoxCollision(box, door)) {
                        resolveBoxCollision(box, door);
                    }
                }
            }
            
            // í”Œë ˆì´ì–´-ë°•ìŠ¤ ì¶©ëŒ (ë°€ê¸°)
            for (let box of gameObjects.boxes) {
                if (checkPlayerBoxCollision(localPlayer, box)) {
                    pushBox(localPlayer, box);
                }
            }
            
            // ë²„íŠ¼ ì²´í¬ (í”Œë ˆì´ì–´ ë˜ëŠ” ë°•ìŠ¤)
            gameObjects.buttons.forEach((button, idx) => {
                let somethingOnButton = false;
                
                // í”Œë ˆì´ì–´ê°€ ë²„íŠ¼ ìœ„ì— ìˆëŠ”ì§€
                const playerOnButton = localPlayer.x + 20 > button.x && 
                                localPlayer.x < button.x + button.width &&
                                localPlayer.y + 40 > button.y &&
                                localPlayer.y + 40 < button.y + button.height + 10;
                if (playerOnButton) somethingOnButton = true;
                
                // ë°•ìŠ¤ê°€ ë²„íŠ¼ ìœ„ì— ìˆëŠ”ì§€
                for (let box of gameObjects.boxes) {
                    const boxOnButton = box.x + box.width/2 > button.x && 
                                       box.x < button.x + button.width &&
                                       box.y + box.height > button.y &&
                                       box.y + box.height < button.y + button.height + 10;
                    if (boxOnButton) somethingOnButton = true;
                }
                
                // ë‹¤ë¥¸ í”Œë ˆì´ì–´ê°€ ë²„íŠ¼ ìœ„ì— ìˆëŠ”ì§€ (ë©€í‹°í”Œë ˆì´)
                if (!isGuestMode) {
                    Object.entries(players).forEach(([sid, p]) => {
                        const rp = getInterpolatedRemote(sid, p || {});
                        const px = (typeof rp.x === 'number') ? rp.x : (p.x || 0);
                        const py = (typeof rp.y === 'number') ? rp.y : (p.y || 0);
                        if (px + 20 > button.x && px < button.x + button.width &&
                            py + 40 > button.y && py + 40 < button.y + button.height + 10) {
                            somethingOnButton = true;
                        }
                    });
                }
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (somethingOnButton && !button.pressed) {
                    button.pressed = true;
                    sfxButton();
                    bridgeSend("tg_button", { idx, pressed: true });
                } else if (!somethingOnButton && button.pressed && !isGuestMode) {
                    // ë©€í‹° ëª¨ë“œì—ì„œë§Œ ë²„íŠ¼ í•´ì œ (ê²ŒìŠ¤íŠ¸ ëª¨ë“œëŠ” ë°•ìŠ¤ë¡œ ì˜êµ¬ ê³ ì •)
                    button.pressed = false;
                    bridgeSend("tg_button", { idx, pressed: false });
                }
            });
            
            localPlayer.onButton = gameObjects.buttons.some(btn => btn.pressed);
            
            updateDoors();
            
            // ì´ë¯¸ ì£½ì€ ìƒíƒœë©´ ì‚¬ë§ ì²˜ë¦¬ ìŠ¤í‚µ
            if (!localPlayer.isDead) {
                // ìŠ¤íŒŒì´í¬ ì¶©ëŒ (ì‚¬ë§)
                for (let spike of gameObjects.spikes) {
                    if (checkCollision(localPlayer, {...spike, height: 20})) {
                        onDeath();
                        return;
                    }
                }
                
                // ë‚™ì‚¬
                if (localPlayer.y > 1000) {
                    onDeath();
                    return;
                }
            }
            
            // ê³¨ ì²´í¬
            const goal = gameObjects.goal;
            if (localPlayer.x + 20 > goal.x && localPlayer.x < goal.x + goal.width &&
                localPlayer.y + 40 > goal.y && localPlayer.y < goal.y + goal.height) {
                // 1ëª…ë§Œ ë„ì°©í•´ë„ í´ë¦¬ì–´
                if (!document.getElementById('winScreen').classList.contains('show')) {
                    sfxLevelClear();
                    document.getElementById('winScreen').classList.add('show');
                    setTimeout(() => nextLevel(), 1500);
                }
            }
            
            // ë„¤íŠ¸ì›Œí¬(ë¸Œë¦¿ì§€)ë¡œ ìƒíƒœ ì „ì†¡
            bridgeSendState();
}
        
        function updateDoors() {
            gameObjects.doors.forEach((door, idx) => {
                const button = gameObjects.buttons.find(b => b.doorId === idx);
                const wasOpen = door.open;
                door.open = button ? button.pressed : false;
                if (!wasOpen && door.open) {
                    sfxDoorOpen();
                }
            });
        }
        
        function onDeath() {
            localPlayer.isDead = true;
            deathCount++;
            updateDeathCountUI();
            sfxDeath();
            
            if (isGuestMode) {
                // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ: ë°”ë¡œ ë§µ ì´ˆê¸°í™”
                showDeathEffect(() => {
                    resetMap();
                });
            } else {
                // ë©€í‹° í”Œë ˆì´: ë¸Œë¦¿ì§€ë¡œ ì‚¬ë§ ìƒíƒœ ì „ì†¡
                bridgeSendState(true);

                // ëª¨ë“  í”Œë ˆì´ì–´ ì‚¬ë§ ì²´í¬
                checkAllDead();
            }
        }
        
        function updateDeathCountUI() {
            document.getElementById('deathCount').textContent = 'ğŸ’€ ' + deathCount;
        }
        
        function showDeathEffect(callback) {
            // ê°„ë‹¨í•œ ì‚¬ë§ ì´í™íŠ¸ (í™”ë©´ ê¹œë¹¡ì„)
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255,0,0,0.3);
                z-index: 500;
                pointer-events: none;
            `;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.remove();
                if (callback) callback();
            }, 300);
        }
        
        function checkAllDead() {
            // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì‚¬ë§í–ˆëŠ”ì§€ í™•ì¸
            let allDead = localPlayer.isDead;
            
            Object.values(players).forEach(p => {
                if (!p.isDead) {
                    allDead = false;
                }
            });
            
            if (allDead && Object.keys(players).length > 0) {
                // ì„ë² ë“œ ë©€í‹°: ì „ì› ì‚¬ë§ = ì‹¤íŒ¨ -> ë¶€ëª¨/ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡
                if (EMBED && !isGuestMode) {
                    bridgeSendOver(false, "all_dead");
                    return;
                }
                // ê·¸ ì™¸(ë¡œì»¬/ê²ŒìŠ¤íŠ¸): í˜¸ìŠ¤íŠ¸ë§Œ ë§µ ë¦¬ì…‹ íŠ¸ë¦¬ê±°
                if (isHost) { bridgeSend("tg_reset", { t: Date.now() }); }
            } else if (allDead && Object.keys(players).length === 0) {
                // í˜¼ì í”Œë ˆì´ ì¤‘ì¸ ê²½ìš°(ì„ë² ë“œë©´ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬)
                if (EMBED && !isGuestMode) {
                    bridgeSendOver(false, "all_dead");
                    return;
                }
                showDeathEffect(() => { resetMap(); });
            }
        }
        
        function resetMap() {
            // ë§µ ì´ˆê¸°í™” (ë²„íŠ¼, ë¬¸ ìƒíƒœ ë¦¬ì…‹)
            loadLevel(currentLevel);
            localPlayer.isDead = false;
            
            // ë¸Œë¦¿ì§€: ë¦¬ì…‹ ì „íŒŒ(í˜¸ìŠ¤íŠ¸ë§Œ)
            if (!isGuestMode && isHost) {
                bridgeSend("tg_reset", { t: Date.now() });
                gameObjects.buttons.forEach((btn, idx) => bridgeSend("tg_button", { idx, pressed: false }));
                bridgeSendState(true);
            }
        }
        
        function respawn() {
            // ê¸°ì¡´ respawnì€ ìœ„ì¹˜ë§Œ ë¦¬ì…‹ (ì‚¬ë§ ì—†ì´ ìœ„ì¹˜ ì¡°ì • í•„ìš”ì‹œ ì‚¬ìš©)
            const level = LEVELS[currentLevel - 1];
            const colorIndex = HAMSTER_COLORS.indexOf(localPlayer.color);
            localPlayer.x = level.spawn.x + (colorIndex * 50);
            localPlayer.y = level.spawn.y;
            localPlayer.vx = 0;
            localPlayer.vy = 0;
        }
        
        function checkCollision(player, rect) {
            return player.x + 40 > rect.x &&
                   player.x < rect.x + rect.width &&
                   player.y + 40 > rect.y &&
                   player.y < rect.y + rect.height;
        }
        
        function resolveCollision(player, rect) {
            const overlapX = Math.min(player.x + 40 - rect.x, rect.x + rect.width - player.x);
            const overlapY = Math.min(player.y + 40 - rect.y, rect.y + rect.height - player.y);
            
            if (overlapX < overlapY) {
                if (player.x < rect.x) {
                    player.x = rect.x - 40;
                } else {
                    player.x = rect.x + rect.width;
                }
                player.vx = 0;
            } else {
                if (player.y < rect.y) {
                    player.y = rect.y - 40;
                    player.onGround = true;
                    player.vy = 0;
                } else {
                    player.y = rect.y + rect.height;
                    player.vy = 0;
                }
            }
        }
        
        // ë°•ìŠ¤ ì¶©ëŒ ì²´í¬
        function checkBoxCollision(box, rect) {
            return box.x + box.width > rect.x &&
                   box.x < rect.x + rect.width &&
                   box.y + box.height > rect.y &&
                   box.y < rect.y + rect.height;
        }
        
        // ë°•ìŠ¤ ì¶©ëŒ í•´ê²°
        function resolveBoxCollision(box, rect) {
            const overlapX = Math.min(box.x + box.width - rect.x, rect.x + rect.width - box.x);
            const overlapY = Math.min(box.y + box.height - rect.y, rect.y + rect.height - box.y);
            
            if (overlapX < overlapY) {
                if (box.x < rect.x) {
                    box.x = rect.x - box.width;
                } else {
                    box.x = rect.x + rect.width;
                }
                box.vx = 0;
            } else {
                if (box.y < rect.y) {
                    box.y = rect.y - box.height;
                    box.vy = 0;
                } else {
                    box.y = rect.y + rect.height;
                    box.vy = 0;
                }
            }
        }
        
        // í”Œë ˆì´ì–´-ë°•ìŠ¤ ì¶©ëŒ ì²´í¬
        function checkPlayerBoxCollision(player, box) {
            return player.x + 40 > box.x &&
                   player.x < box.x + box.width &&
                   player.y + 40 > box.y &&
                   player.y < box.y + box.height;
        }
        
        // ë°•ìŠ¤ ë°€ê¸°
        function pushBox(player, box) {
            const overlapX = Math.min(player.x + 40 - box.x, box.x + box.width - player.x);
            const overlapY = Math.min(player.y + 40 - box.y, box.y + box.height - player.y);
            
            if (overlapX < overlapY) {
                // ì˜†ì—ì„œ ì¶©ëŒ - ë°•ìŠ¤ ë°€ê¸°
                sfxPush();
                if (player.x < box.x) {
                    box.vx = 3;
                    player.x = box.x - 40;
                } else {
                    box.vx = -3;
                    player.x = box.x + box.width;
                }
            } else {
                // ìœ„ì•„ë˜ ì¶©ëŒ
                if (player.y < box.y) {
                    // í”Œë ˆì´ì–´ê°€ ë°•ìŠ¤ ìœ„ì— ì°©ì§€
                    player.y = box.y - 40;
                    player.onGround = true;
                    player.vy = 0;
                } else {
                    // í”Œë ˆì´ì–´ê°€ ë°•ìŠ¤ ì•„ë˜ì—ì„œ ë¶€ë”ªí˜
                    player.y = box.y + box.height;
                    player.vy = 0;
                }
            }
        }
        
        // ==================== ë Œë”ë§ ====================
        function render() {
            // ë°°ê²½
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ì¹´ë©”ë¼ ë”°ë¼ê°€ê¸°
            const targetCameraX = localPlayer.x - canvas.width / 2;
            cameraX += (targetCameraX - cameraX) * 0.1;
            cameraX = Math.max(0, cameraX);
            
            ctx.save();
            ctx.translate(-cameraX, 0);
            
            // ë°°ê²½ ë³„
            for (let i = 0; i < 50; i++) {
                const x = (i * 73 + cameraX * 0.1) % 2500;
                const y = (i * 47) % canvas.height;
                ctx.fillStyle = `rgba(255,255,255,${0.3 + Math.sin(Date.now() / 1000 + i) * 0.2})`;
                ctx.beginPath();
                ctx.arc(x, y, 1 + Math.random(), 0, Math.PI * 2);
                ctx.fill();
            }
            
            // í”Œë«í¼
            gameObjects.platforms.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.width, p.height);
                
                // í•˜ì´ë¼ì´íŠ¸
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(p.x, p.y, p.width, 3);
            });
            
            // ë²„íŠ¼
            gameObjects.buttons.forEach(b => {
                ctx.fillStyle = b.pressed ? '#2d3436' : b.color;
                ctx.fillRect(b.x, b.y + (b.pressed ? 10 : 0), b.width, b.height - (b.pressed ? 5 : 0));
                
                if (!b.pressed) {
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(b.x, b.y, b.width, 3);
                }
            });
            
            // ë¬¸
            gameObjects.doors.forEach(d => {
                if (!d.open) {
                    ctx.fillStyle = d.color;
                    ctx.fillRect(d.x, d.y, d.width, d.height);
                    
                    // íŒ¨í„´
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    for (let i = 0; i < 3; i++) {
                        ctx.fillRect(d.x + 5, d.y + 10 + i * 30, d.width - 10, 20);
                    }
                } else {
                    // ì—´ë¦° ë¬¸
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.fillRect(d.x, d.y, d.width, d.height);
                }
            });
            
            // ìŠ¤íŒŒì´í¬
            gameObjects.spikes.forEach(s => {
                ctx.fillStyle = '#e74c3c';
                const spikeCount = Math.floor(s.width / 15);
                for (let i = 0; i < spikeCount; i++) {
                    ctx.beginPath();
                    ctx.moveTo(s.x + i * 15, s.y + s.height);
                    ctx.lineTo(s.x + i * 15 + 7.5, s.y);
                    ctx.lineTo(s.x + i * 15 + 15, s.y + s.height);
                    ctx.fill();
                }
            });
            
            // ë°•ìŠ¤
            gameObjects.boxes.forEach(box => {
                // ê·¸ë¦¼ì
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(box.x + 4, box.y + 4, box.width, box.height);
                
                // ë°•ìŠ¤ ë³¸ì²´
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(box.x, box.y, box.width, box.height);
                
                // ë‚˜ë¬´ ë¬´ëŠ¬
                ctx.fillStyle = '#a0522d';
                ctx.fillRect(box.x + 3, box.y + 3, box.width - 6, 8);
                ctx.fillRect(box.x + 3, box.y + box.height - 11, box.width - 6, 8);
                
                // í•˜ì´ë¼ì´íŠ¸
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.fillRect(box.x, box.y, box.width, 3);
                ctx.fillRect(box.x, box.y, 3, box.height);
                
                // í…Œë‘ë¦¬
                ctx.strokeStyle = '#5c3317';
                ctx.lineWidth = 2;
                ctx.strokeRect(box.x, box.y, box.width, box.height);
            });
            
            // ê³¨ - ê¹ƒë°œë§Œ í‘œì‹œ
            const goal = gameObjects.goal;
            const flagX = goal.x + goal.width / 2;
            const flagY = goal.y - 30; // ë” ë†’ê²Œ
            const flagHeight = goal.height + 30;
            
            // ê¹ƒë°œ ê¸°ë‘¥
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(flagX - 3, flagY, 6, flagHeight);
            
            // ê¹ƒë°œ ì²œ
            ctx.beginPath();
            ctx.moveTo(flagX + 3, flagY);
            ctx.lineTo(flagX + 45, flagY + 22);
            ctx.lineTo(flagX + 3, flagY + 44);
            ctx.closePath();
            ctx.fillStyle = '#ff6b6b';
            ctx.fill();
            
            // ë°˜ì§ì´ íŒŒí‹°í´ 2~3ê°œ (ìì—°ìŠ¤ëŸ½ê²Œ ë– ë‹¤ë‹ˆëŠ” ëŠë‚Œ)
            const time = Date.now() / 1000;
            for (let i = 0; i < 3; i++) {
                const px = flagX + 20 + Math.sin(time * 0.8 + i * 2.5) * 25;
                const py = flagY + 20 + Math.cos(time * 0.6 + i * 2) * 20 + i * 10;
                const alpha = 0.6 + Math.sin(time * 2 + i) * 0.4;
                ctx.fillStyle = `rgba(255, 255, 150, ${alpha})`;
                ctx.beginPath();
                ctx.arc(px, py, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ (íˆìŠ¤í† ë¦¬ ê¸°ë°˜ ë³´ê°„/ì˜ˆì¸¡ + ìŠ¤ë¬´ë”©)
            Object.entries(players).forEach(([sid, p]) => {
                const tp = getInterpolatedRemote(sid, p || {});
                const initX = (typeof tp.x === 'number') ? tp.x : 0;
                const initY = (typeof tp.y === 'number') ? tp.y : 0;
                const sp = smoothedPlayers[sid] || (smoothedPlayers[sid] = { x: initX, y: initY });

                const tx = (typeof tp.x === 'number') ? tp.x : 0;
                const ty = (typeof tp.y === 'number') ? tp.y : 0;
                const dx = tx - sp.x;
                const dy = ty - sp.y;
                const dist = Math.hypot(dx, dy);

                // ìˆœê°„ì´ë™ê¸‰ ì°¨ì´ëŠ” ë°”ë¡œ ìŠ¤ëƒ… (ì‹¬í•œ ëŠê¹€/íŠ€ëŠ” ëŠë‚Œ ë°©ì§€)
                if (dist > 220) {
                    sp.x = tx;
                    sp.y = ty;
                } else {
                    const k = 0.35;
                    sp.x += dx * k;
                    sp.y += dy * k;
                }

                sp.color = tp.color || p.color;
                sp.name = tp.name || p.name;
                sp.isDead = !!tp.isDead;

                drawHamster(sp.x, sp.y, sp.color, sp.name, false, sp.isDead);
            });
// ë¡œì»¬ í”Œë ˆì´ì–´
            drawHamster(localPlayer.x, localPlayer.y, localPlayer.color, localPlayer.name, true, localPlayer.isDead);
            
            ctx.restore();
        }
        
        function drawHamster(x, y, color, name, isLocal = false, isDead = false) {
            // ì‚¬ë§ ì‹œ ë°˜íˆ¬ëª… ì²˜ë¦¬
            if (isDead) {
                ctx.globalAlpha = 0.4;
            }
            
            // ê·¸ë¦¼ì
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(x + 20, y + 38, 14, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ëª¸í†µ (ë‘¥ê¸€ë‘¥ê¸€í•œ ì›í˜•)
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.ellipse(x + 20, y + 22, 18, 16, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ê·€ (ë‘¥ê·¼ ê·€)
            ctx.beginPath();
            ctx.arc(x + 6, y + 8, 7, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 34, y + 8, 7, 0, Math.PI * 2);
            ctx.fill();
            
            // ê·€ ì•ˆìª½ (ë¶„í™ìƒ‰)
            ctx.fillStyle = '#ffb8b8';
            ctx.beginPath();
            ctx.arc(x + 6, y + 8, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 34, y + 8, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // ë³¼ (í†µí†µí•œ ë³¼ì‚´)
            ctx.fillStyle = 'rgba(255,184,184,0.6)';
            ctx.beginPath();
            ctx.ellipse(x + 6, y + 26, 6, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(x + 34, y + 26, 6, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ëˆˆ (ì‘ê³  ë™ê·¸ë€ ëˆˆ)
            ctx.fillStyle = '#2d3436';
            ctx.beginPath();
            ctx.arc(x + 14, y + 20, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 26, y + 20, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // ëˆˆ í•˜ì´ë¼ì´íŠ¸
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(x + 15, y + 19, 1.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 27, y + 19, 1.2, 0, Math.PI * 2);
            ctx.fill();
            
            // ì½” (ì‘ì€ ë¶„í™ ì½”)
            ctx.fillStyle = '#ff9999';
            ctx.beginPath();
            ctx.arc(x + 20, y + 26, 2, 0, Math.PI * 2);
            ctx.fill();
            
            // ì´ë¦„í‘œ
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.beginPath();
            ctx.roundRect(x - 5, y - 15, 50, 14, 7);
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.font = '9px Jua';
            ctx.textAlign = 'center';
            ctx.fillText(name, x + 20, y - 4);
            
            // ë¡œì»¬ í”Œë ˆì´ì–´ í‘œì‹œ (ì‘ì€ í™”ì‚´í‘œ)
            if (isLocal && !isDead) {
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.moveTo(x + 20, y - 23);
                ctx.lineTo(x + 15, y - 30);
                ctx.lineTo(x + 25, y - 30);
                ctx.closePath();
                ctx.fill();
            }
            
            // ì‚¬ë§ ì‹œ X í‘œì‹œ
            if (isDead) {
                ctx.globalAlpha = 1;
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x + 10, y + 12);
                ctx.lineTo(x + 30, y + 32);
                ctx.moveTo(x + 30, y + 12);
                ctx.lineTo(x + 10, y + 32);
                ctx.stroke();
            }
            
            // globalAlpha ë³µì›
            ctx.globalAlpha = 1;
        }
        
        // ==================== ê²Œì„ ë£¨í”„ ====================
        function gameLoop() {
            updatePhysics();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        
        // ==================== Colyseus ë¸Œë¦¿ì§€ (Firebase ì œê±°) ====================
        let mySessionId = null;
        let mySeat = 0;
        let tgEnded = false; // embed ë©€í‹°ì—ì„œ ê²°ê³¼ ì „ì†¡ ì¤‘ë³µ ë°©ì§€

        function bridgeSendOver(success, reason){
            if (!EMBED || isGuestMode) return;
            if (!isHost) return;
            if (tgEnded) return;
            tgEnded = true;
            bridgeSend("tg_over", { success: !!success, reason: reason || (success ? "clear" : "fail") });
        }

        // ==================== ì›ê²© í”Œë ˆì´ì–´ ë³´ê°„/ì˜ˆì¸¡ ====================
        function recordRemoteSnapshot(sid, p){
            const now = performance.now();
            const arr = remoteHistory[sid] || (remoteHistory[sid] = []);
            arr.push({
                t: now,
                x: (p && typeof p.x === 'number') ? p.x : (p?.x || 0),
                y: (p && typeof p.y === 'number') ? p.y : (p?.y || 0),
                vx: (p && typeof p.vx === 'number') ? p.vx : (p?.vx || 0),
                vy: (p && typeof p.vy === 'number') ? p.vy : (p?.vy || 0),
                isDead: !!p?.isDead,
                color: p?.color,
                name: p?.name
            });

            // íˆìŠ¤í† ë¦¬ ì •ë¦¬
            const cutoff = now - NET_MAX_HISTORY_MS;
            while (arr.length > 2 && arr[1].t < cutoff) arr.shift();
            if (arr.length > 80) arr.splice(0, arr.length - 80);
        }

        function getInterpolatedRemote(sid, fallback){
            const hist = remoteHistory[sid];
            const now = performance.now();
            const renderT = now - NET_INTERP_DELAY_MS;
            if (!hist || hist.length === 0) return fallback || { x: 0, y: 0 };

            // ë„ˆë¬´ ì˜¤ë˜ëœ íˆìŠ¤í† ë¦¬ ì •ë¦¬
            const cutoff = now - NET_MAX_HISTORY_MS;
            while (hist.length > 2 && hist[1].t < cutoff) hist.shift();

            // renderT ì´ì „ì˜ ë§ˆì§€ë§‰ ìŠ¤ëƒ…ìƒ· ì°¾ê¸°
            let i = 0;
            while (i < hist.length - 1 && hist[i + 1].t <= renderT) i++;

            const a = hist[i];
            const b = hist[i + 1];

            // êµ¬ê°„ ë³´ê°„
            if (b && a.t <= renderT && renderT <= b.t) {
                const span = (b.t - a.t) || 1;
                const alpha = (renderT - a.t) / span;
                return {
                    x: a.x + (b.x - a.x) * alpha,
                    y: a.y + (b.y - a.y) * alpha,
                    vx: b.vx,
                    vy: b.vy,
                    isDead: !!b.isDead,
                    color: b.color,
                    name: b.name
                };
            }

            // ìµœì‹  ìŠ¤ëƒ…ìƒ· ì´í›„ë©´ ì§§ê²Œ ì˜ˆì¸¡ (ëŠê¹€ ì™„í™”)
            const last = hist[hist.length - 1];
            const dtMs = Math.max(0, Math.min(200, renderT - last.t));
            const frames = dtMs / 16.6667;
            const g = 0.6;
            return {
                x: last.x + (last.vx || 0) * frames,
                y: last.y + (last.vy || 0) * frames + 0.5 * g * frames * frames,
                vx: last.vx,
                vy: last.vy,
                isDead: !!last.isDead,
                color: last.color,
                name: last.name
            };
        }

        function applyRemotePlayers(map){
            const next = {};
            if (!map) map = {};
            for (const [sid, p] of Object.entries(map)){
                if (sid === mySessionId) continue;
                next[sid] = p;
                // ìŠ¤ëƒ…ìƒ· ê¸°ë¡ (ë³´ê°„/ì˜ˆì¸¡)
                recordRemoteSnapshot(sid, p);
                // init smoothing slot
                if (!smoothedPlayers[sid]){
                    smoothedPlayers[sid] = { x: p.x||0, y: p.y||0, vx: p.vx||0, vy: p.vy||0, isDead: !!p.isDead };
                }
                // keep name/color immediately (no alpha)
                smoothedPlayers[sid].name = p.name;
                smoothedPlayers[sid].color = p.color;
            }
            players = next;
            // prune removed
            for (const sid of Object.keys(smoothedPlayers)){
                if (!players[sid]) delete smoothedPlayers[sid];
            }
            for (const sid of Object.keys(remoteHistory)){
                if (!players[sid]) delete remoteHistory[sid];
            }
            updatePlayerList();
        }

        function applyButtons(btnMap){
            if (!btnMap || !gameObjects?.buttons) return;
            for (const [idxStr, pressed] of Object.entries(btnMap)){
                const idx = parseInt(idxStr, 10);
                if (gameObjects.buttons[idx]) gameObjects.buttons[idx].pressed = !!pressed;
            }
            updateDoors();
        }

        function bridgeSendState(force=false){
            if (!EMBED || isGuestMode) return;
            const now = performance.now();
            if (!force && bridgeSendState._t && (now - bridgeSendState._t) < 33) return; // ~20Hz
            bridgeSendState._t = now;
            bridgeSend("tg_state", {
                state: {
                    x: localPlayer.x, y: localPlayer.y,
                    vx: localPlayer.vx, vy: localPlayer.vy,
                    onGround: !!localPlayer.onGround,
                    onButton: !!localPlayer.onButton,
                    isDead: !!localPlayer.isDead,
                    color: localPlayer.color,
                    name: localPlayer.name,
                    level: currentLevel,
                    deathCount
                }
            });
        }

        // Embed ëª¨ë“œ ì§„ì…: ë‚´ë¶€ ë¡œë¹„/ì„¤ì • UI ì œê±°, ë¶€ëª¨ì—ê²Œ ì¤€ë¹„ ì‹ í˜¸
        if (EMBED){
            try{
                const lobby = document.getElementById('lobby');
                if (lobby){
                    // ë¡œë¹„ UIëŠ” ë¶€ëª¨ ë¡œë¹„ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ìµœì†Œí™”
                    const hide = lobby.querySelectorAll('button, details, .input-group');
                    hide.forEach(el => el.style.display = 'none');
                    const subtitle = lobby.querySelector('.lobby-subtitle');
                    if (subtitle) subtitle.textContent = 'ì—°ê²° ì¤‘...';
                }
                bridgeSend("bridge_ready", {});
            }catch(e){}
        }

        window.addEventListener("message", (e)=>{
            const d = e.data || {};
            if (!d || typeof d !== "object") return;

            if (d.type === "bridge_init"){
                mySessionId = String(d.sessionId || "");
                mySeat = typeof d.seat === "number" ? d.seat : 0;
                startEmbedded({
                    nick: d.nick || "í–„ì°Œ",
                    seat: mySeat,
                    isHost: !!d.isHost,
                    sessionId: mySessionId,
                    roomCode: d.roomCode || "ROOM"
                });
                if (d.players) applyRemotePlayers(d.players);
                if (d.level) {
                    const lv = parseInt(d.level, 10);
                    if (lv) { currentLevel = lv; }
                }
                return;
            }

            if (d.type === "tg_players"){
                applyRemotePlayers(d.players || {});
                return;
            }

            if (d.type === "tg_level"){
                const lv = parseInt(d.level, 10);
                if (lv && lv !== currentLevel){
                    currentLevel = lv;
                    loadLevel(currentLevel);
                }
                return;
            }

            if (d.type === "tg_buttons"){
                applyButtons(d.buttons || {});
                return;
            }

            if (d.type === "tg_button"){
                if (gameObjects?.buttons && gameObjects.buttons[d.idx]){
                    gameObjects.buttons[d.idx].pressed = !!d.pressed;
                    updateDoors();
                }
                return;
            }

            if (d.type === "tg_reset"){
                showDeathEffect(()=> resetMap());
                return;
            }
        });

// í˜ì´ì§€ ë¡œë“œì‹œ ì €ì¥ëœ ì´ë¦„ ë³µì›
        const savedName = localStorage.getItem('playerName');
        if (savedName) {
            document.getElementById('playerName').value = savedName;
        }
        
        document.getElementById('playerName').addEventListener('change', (e) => {
            localStorage.setItem('playerName', e.target.value);
        });
    </script>
</body>
</html>
