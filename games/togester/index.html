<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>üêπ Ìà¨Í≤åÏä§ÌÑ∞ - ÌòëÎèô ÌîåÎû´Ìèº Í≤åÏûÑ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Black+Han+Sans&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-family: 'Jua', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #lobby {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        #lobby.hidden {
            display: none;
        }
        
        .lobby-title {
            font-family: 'Black Han Sans', sans-serif;
            font-size: clamp(2rem, 8vw, 4rem);
            color: #fff;
            text-shadow: 4px 4px 0 #e94560, 8px 8px 0 rgba(0,0,0,0.2);
            margin-bottom: 10px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .lobby-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            margin-bottom: 30px;
        }
        
        .cat-parade {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .cat-preview {
            width: 50px;
            height: 55px;
            animation: parade 0.5s ease infinite alternate;
        }
        
        .cat-preview:nth-child(2) { animation-delay: 0.1s; }
        .cat-preview:nth-child(3) { animation-delay: 0.2s; }
        .cat-preview:nth-child(4) { animation-delay: 0.3s; }
        
        @keyframes parade {
            from { transform: translateY(0) rotate(-5deg); }
            to { transform: translateY(-10px) rotate(5deg); }
        }
        
        .input-group {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .input-group label {
            display: block;
            color: rgba(255,255,255,0.9);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-family: 'Jua', sans-serif;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-family: 'Black Han Sans', sans-serif;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .btn-create {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
        }
        
        .btn-join {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
        }
        
        .btn-guest {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            width: 100%;
            max-width: 280px;
        }
        
        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #gameHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .room-code {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .level-info {
            color: #ffd700;
            font-size: 1rem;
        }
        
        .death-count {
            color: #ff6b6b;
            font-size: 0.9rem;
            background: rgba(255,107,107,0.2);
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        #gameCanvas {
            flex: 1;
            width: 100%;
        }
        
        #playerList {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            padding: 10px;
            border-radius: 10px;
            z-index: 100;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            color: white;
            font-size: 0.85rem;
        }
        
        .player-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        #controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.75rem;
            text-align: center;
            z-index: 100;
            opacity: 0.8;
            max-width: 90%;
            white-space: nowrap;
        }
        
        #winScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        #winScreen.show {
            display: flex;
        }
        
        .win-text {
            font-family: 'Black Han Sans', sans-serif;
            font-size: clamp(2rem, 10vw, 5rem);
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
            animation: pulse 0.5s ease infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .firebase-config {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            max-width: 300px;
            width: 100%;
        }
        
        .firebase-config summary {
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .firebase-config input {
            width: 100%;
            padding: 8px 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            background: rgba(255,255,255,0.9);
        }
        
        .error-msg {
            color: #ff6b6b;
            background: rgba(255,107,107,0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            display: none;
        }
        
        .error-msg.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Î°úÎπÑ ÌôîÎ©¥ -->
    <div id="lobby">
        <h1 class="lobby-title">üêπ Ìà¨Í≤åÏä§ÌÑ∞</h1>
        <p class="lobby-subtitle">ÏµúÎåÄ 4Î™ÖÏù¥ Ìï®ÍªòÌïòÎäî ÌòëÎèô ÌîåÎû´Ìèº Í≤åÏûÑ!</p>
        
        <div class="cat-parade">
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#ff6b6b"/>
                <circle cx="8" cy="10" r="6" fill="#ff6b6b"/>
                <circle cx="32" cy="10" r="6" fill="#ff6b6b"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#4ecdc4"/>
                <circle cx="8" cy="10" r="6" fill="#4ecdc4"/>
                <circle cx="32" cy="10" r="6" fill="#4ecdc4"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#ffe66d"/>
                <circle cx="8" cy="10" r="6" fill="#ffe66d"/>
                <circle cx="32" cy="10" r="6" fill="#ffe66d"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
            <svg class="cat-preview" viewBox="0 0 40 40">
                <circle cx="20" cy="22" r="16" fill="#a29bfe"/>
                <circle cx="8" cy="10" r="6" fill="#a29bfe"/>
                <circle cx="32" cy="10" r="6" fill="#a29bfe"/>
                <circle cx="8" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="32" cy="10" r="3" fill="#ffb8b8"/>
                <circle cx="14" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="26" cy="20" r="2.5" fill="#2d3436"/>
                <circle cx="15" cy="19" r="1" fill="white"/>
                <circle cx="27" cy="19" r="1" fill="white"/>
                <ellipse cx="9" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
                <ellipse cx="31" cy="26" rx="5" ry="4" fill="#ffb8b8" opacity="0.7"/>
            </svg>
        </div>
        
        <div class="input-group">
            <label>ÎãâÎÑ§ÏûÑ</label>
            <input type="text" id="playerName" placeholder="ÌñÑÏä§ÌÑ∞ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="10">
        </div>
        
        <div class="input-group">
            <label>Î∞© ÏΩîÎìú (Ï∞∏Í∞ÄÏãú)</label>
            <input type="text" id="roomCode" placeholder="Î∞© ÏΩîÎìú ÏûÖÎ†•" maxlength="6" style="text-transform: uppercase;">
        </div>
        
        <div>
            <button class="btn btn-create" onclick="createRoom()">üè† Î∞© ÎßåÎì§Í∏∞</button>
            <button class="btn btn-join" onclick="joinRoom()">üö™ Ï∞∏Í∞ÄÌïòÍ∏∞</button>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="btn btn-guest" onclick="startGuestMode()">üéÆ ÌòºÏûê Ïó∞ÏäµÌïòÍ∏∞</button>
        </div>
        
        <div id="errorMsg" class="error-msg"></div>
    </div>
    
    <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
    <div id="gameContainer" style="display:none;">
        <div id="gameHeader">
            <span class="room-code" id="displayRoomCode">Î∞©: ----</span>
            <span class="level-info" id="levelInfo">Î†àÎ≤® 1</span>
            <span class="death-count" id="deathCount">üíÄ 0</span>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div id="playerList"></div>
        
        <div id="controls-hint">
            Ï¢å/Ïö∞ ÌÅ¥Î¶≠: Ïù¥Îèô | ÏñëÏ™Ω ÌÅ¥Î¶≠: Ï†êÌîÑ | Î∞ïÏä§Î•º Î∞ÄÏñ¥ÏÑú Î≤ÑÌäºÏùÑ ÎàåÎü¨Ïöî!
        </div>
    </div>
    
    <!-- ÏäπÎ¶¨ ÌôîÎ©¥ -->
    <div id="winScreen">
        <div class="win-text">üéâ Î†àÎ≤® ÌÅ¥Î¶¨Ïñ¥! üéâ</div>
        <div id="autoNextHint" style="color: #aaa; margin-top: 15px; font-size: 0.9rem;">Ïû†Ïãú ÌõÑ Îã§Ïùå Î†àÎ≤®Î°ú...</div>
    </div>
<script>
        // ==================== ÏÑ§Ï†ï ====================
        // Firebase ÏùòÏ°¥ÏÑ± Ï†úÍ±∞ (Colyseus/Î∂ÄÎ™® Î∏åÎ¶øÏßÄÎ°ú ÎèôÍ∏∞Ìôî)
        const EMBED = new URLSearchParams(location.search).get('embed') === '1';
        function bridgeSend(type, payload){
            if (!EMBED) return;
            try { window.parent && window.parent.postMessage({ type, ...payload }, '*'); } catch(e){}
        }

        // ==================== Í≤åÏûÑ ÏÉÅÌÉú ====================
        let db = null;
        let roomRef = null;
        let playerId = null;
        let roomId = null;
        let isHost = false;
        let isGuestMode = false;
        let currentLevel = 1;
        
        const HAMSTER_COLORS = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#a29bfe'];
        
        let localPlayer = {
            x: 100,
            y: 300,
            vx: 0,
            vy: 0,
            color: HAMSTER_COLORS[0],
            name: 'ÌñÑÏ∞å',
            onGround: false,
            onButton: false,
            isDead: false
        };
        
        let players = {};
        let smoothedPlayers = {};
        let gameObjects = [];
        let canvas, ctx;
        let cameraX = 0;
        let deathCount = 0; // ÌòÑÏû¨ Î†àÎ≤® ÏÇ¨Îßù ÌöüÏàò
        
        // ÌÑ∞Ïπò ÏÉÅÌÉú
        let touches = {};
        let moveDirection = 0; // -1: ÏôºÏ™Ω, 0: Ï†ïÏßÄ, 1: Ïò§Î•∏Ï™Ω
        
        // ==================== ÏÇ¨Ïö¥Îìú ÏãúÏä§ÌÖú ====================
        let audioCtx = null;
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        function playTone(frequency, duration, type = 'square', volume = 0.3, slide = 0) {
            if (!audioCtx) return;
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            
            if (slide !== 0) {
                oscillator.frequency.linearRampToValueAtTime(frequency + slide, audioCtx.currentTime + duration);
            }
            
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration);
        }
        
        // Ï†êÌîÑ ÏÜåÎ¶¨ - Í∑ÄÏó¨Ïö¥ "ÎøÖ!"
        function sfxJump() {
            initAudio();
            playTone(400, 0.1, 'sine', 0.2, 400);
        }
        
        // Î≤ÑÌäº ÎàÑÎ¶Ñ - Î∞ùÏùÄ "Îî©!"
        function sfxButton() {
            initAudio();
            playTone(880, 0.1, 'sine', 0.2);
            setTimeout(() => playTone(1100, 0.15, 'sine', 0.15), 50);
        }
        
        // Î¨∏ Ïó¥Î¶º - ÏÉÅÏäπ Î©úÎ°úÎîî
        function sfxDoorOpen() {
            initAudio();
            playTone(440, 0.1, 'triangle', 0.15);
            setTimeout(() => playTone(550, 0.1, 'triangle', 0.15), 80);
            setTimeout(() => playTone(660, 0.15, 'triangle', 0.15), 160);
        }
        
        // ÏÇ¨Îßù - Ïä¨Ìîà ÌïòÍ∞ïÏùå
        function sfxDeath() {
            initAudio();
            playTone(400, 0.15, 'square', 0.2, -200);
            setTimeout(() => playTone(200, 0.3, 'square', 0.15, -100), 150);
        }
        
        // Î†àÎ≤® ÌÅ¥Î¶¨Ïñ¥ - Ï∂ïÌïò Î©úÎ°úÎîî
        function sfxLevelClear() {
            initAudio();
            const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            notes.forEach((note, i) => {
                setTimeout(() => playTone(note, 0.15, 'sine', 0.2), i * 100);
            });
        }
        
        // Í≤åÏûÑ ÌÅ¥Î¶¨Ïñ¥ - Í∏¥ Ï∂ïÌïò Î©úÎ°úÎîî
        function sfxGameClear() {
            initAudio();
            const notes = [523, 587, 659, 698, 784, 880, 988, 1047]; // C major scale
            notes.forEach((note, i) => {
                setTimeout(() => playTone(note, 0.2, 'sine', 0.25), i * 120);
            });
            setTimeout(() => {
                playTone(1047, 0.4, 'sine', 0.3);
                playTone(1319, 0.4, 'sine', 0.2);
                playTone(1568, 0.4, 'sine', 0.2);
            }, notes.length * 120);
        }
        
        // Í±∑Í∏∞ ÏÜåÎ¶¨ (ÏûëÏùÄ Î∞úÏÜåÎ¶¨)
        let lastStepTime = 0;
        function sfxStep() {
            const now = Date.now();
            if (now - lastStepTime < 200) return; // 200msÎßàÎã§ Ìïú Î≤à
            lastStepTime = now;
            initAudio();
            playTone(100 + Math.random() * 50, 0.05, 'sine', 0.05);
        }
        
        // Î∞ïÏä§ Î∞ÄÍ∏∞ ÏÜåÎ¶¨
        let lastPushTime = 0;
        function sfxPush() {
            const now = Date.now();
            if (now - lastPushTime < 150) return;
            lastPushTime = now;
            initAudio();
            playTone(150, 0.08, 'square', 0.1);
        }
        
        
        // ==================== Î†àÎ≤® Îç∞Ïù¥ÌÑ∞ ====================
        // Ï†êÌîÑ: ÏïΩ 150px ÎÜíÏù¥, 200px Í±∞Î¶¨
        const LEVELS = [
            // ===== 1-5: ÌäúÌÜ†Î¶¨Ïñº =====
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 600, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 800, height: 50, color: '#2d3436' }],
                buttons: [], doors: [], spikes: [], boxes: [],
                message: "Ïù¥Îèô: Ï¢åÏö∞ ÌÅ¥Î¶≠"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 500, y: 250, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 350, y: 300, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [], doors: [], spikes: [], boxes: [],
                message: "Ï†êÌîÑ: ÏñëÏ™Ω ÎèôÏãú ÌÅ¥Î¶≠"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 550, y: 250, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 700, height: 50, color: '#2d3436' },
                    { x: 450, y: 300, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [], doors: [], spikes: [],
                boxes: [{ x: 300, y: 360, width: 40, height: 40 }],
                message: "Î∞ïÏä§Î•º Î∞ÄÏñ¥ÏÑú Î∞úÌåêÏúºÎ°ú!"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 600, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 800, height: 50, color: '#2d3436' }],
                buttons: [{ x: 250, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 450, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 150, y: 360, width: 40, height: 40 }],
                message: "Î∞ïÏä§Î°ú Î≤ÑÌäºÏùÑ ÎàåÎü¨ Î¨∏ÏùÑ Ïó¥Ïñ¥!"
            },
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 600, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 800, height: 50, color: '#2d3436' }],
                buttons: [], doors: [],
                spikes: [{ x: 300, y: 380, width: 60, height: 20 }],
                boxes: [{ x: 180, y: 360, width: 40, height: 40 }],
                message: "Î∞ïÏä§ ÏúÑÎ°ú Ï†êÌîÑÌï¥ÏÑú Ïä§ÌååÏù¥ÌÅ¨Î•º ÎÑòÏñ¥!"
            },

            // ===== 6-10: Í∏∞Î≥∏ ÌçºÏ¶ê (ÏÑ†ÌÉùÍ≥º ÏàúÏÑú) =====
            // 6: Î∞ïÏä§ ÏúÑÏπò ÏÑ†ÌÉù - Ïä§ÌååÏù¥ÌÅ¨Î•º ÎÑòÏùÑÍπå Î≤ÑÌäºÏùÑ ÎàÑÎ•ºÍπå
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 800, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1000, height: 50, color: '#2d3436' }],
                buttons: [{ x: 600, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 350, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [{ x: 480, y: 380, width: 60, height: 20 }],
                boxes: [{ x: 200, y: 360, width: 40, height: 40 }],
                message: "Î∞ïÏä§Î°ú Î≤ÑÌäº? Ïä§ÌååÏù¥ÌÅ¨? ÏàúÏÑúÍ∞Ä Ï§ëÏöî!"
            },
            // 7: Îëê Í∞úÏùò Ïä§ÌååÏù¥ÌÅ¨ - Î∞ïÏä§ ÌïòÎÇòÎ°ú Ï†êÌîÑÏ†êÌîÑ
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 700, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 900, height: 50, color: '#2d3436' }],
                buttons: [], doors: [],
                spikes: [
                    { x: 280, y: 380, width: 60, height: 20 },
                    { x: 450, y: 380, width: 60, height: 20 }
                ],
                boxes: [{ x: 150, y: 360, width: 40, height: 40 }],
                message: "Î∞ïÏä§ ÌïòÎÇòÎ°ú Ïä§ÌååÏù¥ÌÅ¨ Îëê Í∞úÎ•º!"
            },
            // 8: Î∞ïÏä§ 2Í∞ú Ïó≠Ìï† Î∂ÑÎã¥
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 850, y: 250, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 700, height: 50, color: '#2d3436' },
                    { x: 750, y: 300, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 350, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 600, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 500, y: 360, width: 40, height: 40 }
                ],
                message: "ÌïòÎÇòÎäî Î≤ÑÌäºÏóê, ÌïòÎÇòÎäî Î∞úÌåêÏúºÎ°ú!"
            },
            // 9: ÎêòÎèåÏïÑÏò§Í∏∞
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 100, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 400, height: 50, color: '#2d3436' },
                    { x: 500, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 0, y: 250, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 600, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 430, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 200, y: 360, width: 40, height: 40 }],
                message: "Ïò§Î•∏Ï™Ω Í∞îÎã§ ÎèåÏïÑÏôÄÏïº Ìï¥!"
            },
            // 10: Îëê Í∞úÏùò Î¨∏
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 950, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1150, height: 50, color: '#2d3436' }],
                buttons: [
                    { x: 250, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 550, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 400, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 700, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 480, y: 360, width: 40, height: 40 }
                ],
                message: "Î∞ïÏä§ 2Í∞úÎ°ú Î¨∏ 2Í∞ú!"
            },

            // ===== 11-15: Ï§ëÍ∏â (Î≥µÌï© ÌçºÏ¶ê) =====
            // 11: Ìï®Ï†ï Íµ¨Î©ç - Î∞ïÏä§ Îñ®Ïñ¥Îú®Î¶¨Î©¥ ÎÅù
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 750, y: 350, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 280, height: 50, color: '#2d3436' },
                    { x: 360, y: 400, width: 550, height: 50, color: '#2d3436' },
                ],
                buttons: [{ x: 500, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 630, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 150, y: 360, width: 40, height: 40 }],
                message: "Íµ¨Î©çÏóê Î∞ïÏä§ Îπ†Îú®Î¶¨ÏßÄ Îßà!"
            },
            // 12: Ïä§ÌååÏù¥ÌÅ¨ + Î¨∏ Ï°∞Ìï©
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 900, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1100, height: 50, color: '#2d3436' }],
                buttons: [{ x: 300, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 500, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [
                    { x: 620, y: 380, width: 60, height: 20 },
                    { x: 750, y: 380, width: 60, height: 20 }
                ],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 550, y: 360, width: 40, height: 40 }
                ],
                message: "Î≤ÑÌäºÏö© + Ïä§ÌååÏù¥ÌÅ¨Ïö©!"
            },
            // 13: Î∞ïÏä§ Îã§Î¶¨
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 650, y: 350, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 250, height: 50, color: '#2d3436' },
                    { x: 400, y: 400, width: 450, height: 50, color: '#2d3436' },
                ],
                buttons: [], doors: [],
                spikes: [{ x: 270, y: 500, width: 110, height: 20 }],
                boxes: [
                    { x: 100, y: 360, width: 40, height: 40 },
                    { x: 160, y: 360, width: 40, height: 40 }
                ],
                message: "Î∞ïÏä§Î°ú Îã§Î¶¨Î•º ÎßåÎì§Ïñ¥!"
            },
            // 14: Ï§ëÍ∞Ñ Î∞úÌåê
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 700, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 400, height: 50, color: '#2d3436' },
                    { x: 250, y: 480, width: 150, height: 20, color: '#636e72' },
                    { x: 500, y: 360, width: 150, height: 20, color: '#636e72' },
                    { x: 600, y: 250, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 300, y: 460, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 430, y: 260, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 150, y: 560, width: 40, height: 40 }],
                message: "Î∞ïÏä§Î•º ÏúÑÏ∏µÏúºÎ°ú Ïò¨Î†§!"
            },
            // 15: Î∞ïÏä§ 1Í∞úÎ°ú Î¨∏ 2Í∞ú (ÏàúÏÑú ÌçºÏ¶ê)
            {
                spawn: { x: 450, y: 350 },
                goal: { x: 450, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 350, y: 400, width: 200, height: 50, color: '#2d3436' },
                    { x: 50, y: 400, width: 150, height: 50, color: '#2d3436' },
                    { x: 700, y: 400, width: 150, height: 50, color: '#2d3436' },
                    { x: 350, y: 200, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 80, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 750, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 250, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 610, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [{ x: 430, y: 360, width: 40, height: 40 }],
                message: "Î∞ïÏä§ 1Í∞úÎ°ú Î¨∏ 2Í∞ú! Ïñ¥Îäê Ï™Ω Î®ºÏ†Ä?"
            },

            // ===== 16-20: Í≥†Í∏â (Î≥µÏû°Ìïú Íµ¨Ï°∞) =====
            // 16: 3Îã® Ï†êÌîÑ
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 700, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 350, height: 50, color: '#2d3436' },
                    { x: 200, y: 480, width: 150, height: 20, color: '#636e72' },
                    { x: 400, y: 360, width: 150, height: 20, color: '#636e72' },
                    { x: 600, y: 240, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 650, y: 220, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 530, y: 140, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [{ x: 100, y: 560, width: 40, height: 40 }],
                message: "Î∞ïÏä§Î•º ÎÅùÍπåÏßÄ Î∞ÄÏñ¥ Ïò¨Î†§!"
            },
            // 17: 3Í∞úÏùò Î¨∏
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 1150, y: 350, width: 80, height: 50 },
                platforms: [{ x: 0, y: 400, width: 1350, height: 50, color: '#2d3436' }],
                buttons: [
                    { x: 200, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 500, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false },
                    { x: 800, y: 380, width: 60, height: 20, color: '#a29bfe', doorId: 2, pressed: false }
                ],
                doors: [
                    { x: 350, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 650, y: 300, width: 40, height: 100, color: '#00cec9', open: false },
                    { x: 950, y: 300, width: 40, height: 100, color: '#a29bfe', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 420, y: 360, width: 40, height: 40 },
                    { x: 720, y: 360, width: 40, height: 40 }
                ],
                message: "Î∞ïÏä§ 2Í∞úÎ°ú Î¨∏ 3Í∞ú!"
            },
            // 18: Î≥µÌï© ÏßÄÌòï
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 950, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 380, y: 400, width: 300, height: 50, color: '#2d3436' },
                    { x: 760, y: 400, width: 350, height: 50, color: '#2d3436' },
                    { x: 850, y: 250, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 500, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 690, y: 300, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [
                    { x: 310, y: 500, width: 60, height: 20 },
                    { x: 850, y: 380, width: 60, height: 20 }
                ],
                boxes: [
                    { x: 150, y: 360, width: 40, height: 40 },
                    { x: 800, y: 360, width: 40, height: 40 }
                ],
                message: "Íµ¨Î©ç + Ïä§ÌååÏù¥ÌÅ¨ + Î¨∏!"
            },
            // 19: Ïó≠Î∞©Ìñ• ÏßÑÌñâ
            {
                spawn: { x: 900, y: 350 },
                goal: { x: 100, y: 200, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 400, height: 50, color: '#2d3436' },
                    { x: 500, y: 400, width: 550, height: 50, color: '#2d3436' },
                    { x: 0, y: 250, width: 250, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 700, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 250, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 430, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 50, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 800, y: 360, width: 40, height: 40 },
                    { x: 550, y: 360, width: 40, height: 40 }
                ],
                message: "Ïò§Î•∏Ï™ΩÏóêÏÑú ÏãúÏûë! ÏôºÏ™ΩÏúºÎ°ú!"
            },
            // 20: ÌÉÄÏõå ÏåìÍ∏∞
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 350, y: 100, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 600, height: 50, color: '#2d3436' },
                    { x: 300, y: 150, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [{ x: 100, y: 580, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false }],
                doors: [{ x: 250, y: 250, width: 40, height: 100, color: '#d63031', open: false }],
                spikes: [],
                boxes: [
                    { x: 200, y: 560, width: 40, height: 40 },
                    { x: 260, y: 560, width: 40, height: 40 },
                    { x: 320, y: 560, width: 40, height: 40 }
                ],
                message: "Î∞ïÏä§Î•º ÏåìÏïÑ ÌÉëÏùÑ ÎßåÎì§Ïñ¥!"
            },

            // ===== 21-25: ÎßàÏä§ÌÑ∞ =====
            // 21: ÏñëÍ∞àÎûò + Ï§ëÏïô Î™©Ìëú
            {
                spawn: { x: 450, y: 550 },
                goal: { x: 450, y: 100, width: 80, height: 50 },
                platforms: [
                    { x: 350, y: 600, width: 200, height: 50, color: '#2d3436' },
                    { x: 50, y: 450, width: 200, height: 50, color: '#2d3436' },
                    { x: 650, y: 450, width: 200, height: 50, color: '#2d3436' },
                    { x: 50, y: 300, width: 150, height: 20, color: '#636e72' },
                    { x: 700, y: 300, width: 150, height: 20, color: '#636e72' },
                    { x: 350, y: 150, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 80, y: 280, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 750, y: 280, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 280, y: 50, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 580, y: 50, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 400, y: 560, width: 40, height: 40 },
                    { x: 460, y: 560, width: 40, height: 40 }
                ],
                message: "ÏñëÏ™ΩÏóê Î∞ïÏä§Î•º Î∞∞Ïπò!"
            },
            // 22: Ïó∞ÏáÑ Ïö¥Î∞ò
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 1050, y: 350, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 280, height: 50, color: '#2d3436' },
                    { x: 360, y: 400, width: 200, height: 50, color: '#2d3436' },
                    { x: 640, y: 400, width: 550, height: 50, color: '#2d3436' },
                ],
                buttons: [
                    { x: 150, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 420, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 290, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 570, y: 300, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [{ x: 800, y: 380, width: 100, height: 20 }],
                boxes: [
                    { x: 400, y: 360, width: 40, height: 40 },
                    { x: 700, y: 360, width: 40, height: 40 }
                ],
                message: "Î∞ïÏä§Î•º ÏàúÏÑúÎåÄÎ°ú ÏòÆÍ≤®!"
            },
            // 23: 4Ï∏µ ÌÉë
            {
                spawn: { x: 100, y: 700 },
                goal: { x: 700, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 750, width: 350, height: 50, color: '#2d3436' },
                    { x: 200, y: 620, width: 150, height: 20, color: '#636e72' },
                    { x: 400, y: 490, width: 150, height: 20, color: '#636e72' },
                    { x: 550, y: 360, width: 150, height: 20, color: '#636e72' },
                    { x: 600, y: 230, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 100, y: 730, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 580, y: 340, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false }
                ],
                doors: [
                    { x: 130, y: 650, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 530, y: 130, width: 40, height: 100, color: '#00cec9', open: false }
                ],
                spikes: [],
                boxes: [
                    { x: 200, y: 710, width: 40, height: 40 },
                    { x: 450, y: 450, width: 40, height: 40 }
                ],
                message: "Ï∏µÏ∏µÏù¥ Î∞ïÏä§Î•º Ïò¨Î†§!"
            },
            // 24: ÏµúÌõÑÏùò ÏãúÌóò
            {
                spawn: { x: 100, y: 350 },
                goal: { x: 1000, y: 150, width: 80, height: 50 },
                platforms: [
                    { x: 0, y: 400, width: 280, height: 50, color: '#2d3436' },
                    { x: 360, y: 400, width: 250, height: 50, color: '#2d3436' },
                    { x: 690, y: 400, width: 450, height: 50, color: '#2d3436' },
                    { x: 350, y: 280, width: 150, height: 20, color: '#636e72' },
                    { x: 650, y: 280, width: 150, height: 20, color: '#636e72' },
                    { x: 900, y: 200, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 150, y: 380, width: 60, height: 20, color: '#e17055', doorId: 0, pressed: false },
                    { x: 450, y: 380, width: 60, height: 20, color: '#00b894', doorId: 1, pressed: false },
                    { x: 400, y: 260, width: 60, height: 20, color: '#a29bfe', doorId: 2, pressed: false }
                ],
                doors: [
                    { x: 290, y: 300, width: 40, height: 100, color: '#d63031', open: false },
                    { x: 620, y: 300, width: 40, height: 100, color: '#00cec9', open: false },
                    { x: 830, y: 100, width: 40, height: 100, color: '#a29bfe', open: false }
                ],
                spikes: [{ x: 750, y: 380, width: 60, height: 20 }],
                boxes: [
                    { x: 400, y: 360, width: 40, height: 40 },
                    { x: 700, y: 260, width: 40, height: 40 }
                ],
                message: "Î∞ïÏä§ 2Í∞úÎ°ú Î¨∏ 3Í∞ú! ÏàúÏÑúÍ∞Ä ÌïµÏã¨!"
            },
            // 25: ÏµúÏ¢Ö Î≥¥Ïä§
            {
                spawn: { x: 100, y: 550 },
                goal: { x: 950, y: 100, width: 100, height: 50 },
                platforms: [
                    { x: 0, y: 600, width: 350, height: 50, color: '#2d3436' },
                    { x: 430, y: 600, width: 300, height: 50, color: '#2d3436' },
                    { x: 810, y: 600, width: 300, height: 50, color: '#2d3436' },
                    { x: 200, y: 480, width: 150, height: 20, color: '#636e72' },
                    { x: 500, y: 380, width: 150, height: 20, color: '#636e72' },
                    { x: 750, y: 280, width: 150, height: 20, color: '#636e72' },
                    { x: 850, y: 150, width: 200, height: 20, color: '#636e72' },
                ],
                buttons: [
                    { x: 150, y: 580, width: 60, height: 20, color: '#ff6b6b', doorId: 0, pressed: false },
                    { x: 530, y: 580, width: 60, height: 20, color: '#4ecdc4', doorId: 1, pressed: false },
                    { x: 900, y: 580, width: 60, height: 20, color: '#ffe66d', doorId: 2, pressed: false },
                    { x: 550, y: 360, width: 60, height: 20, color: '#a29bfe', doorId: 3, pressed: false }
                ],
                doors: [
                    { x: 360, y: 500, width: 40, height: 100, color: '#ff6b6b', open: false },
                    { x: 740, y: 500, width: 40, height: 100, color: '#4ecdc4', open: false },
                    { x: 680, y: 180, width: 40, height: 100, color: '#ffe66d', open: false },
                    { x: 800, y: 50, width: 40, height: 100, color: '#a29bfe', open: false }
                ],
                spikes: [
                    { x: 250, y: 460, width: 60, height: 20 },
                    { x: 600, y: 580, width: 60, height: 20 }
                ],
                boxes: [
                    { x: 250, y: 560, width: 40, height: 40 },
                    { x: 480, y: 560, width: 40, height: 40 },
                    { x: 800, y: 260, width: 40, height: 40 }
                ],
                message: "üéä ÏµúÏ¢Ö! Î∞ïÏä§ 3Í∞úÎ°ú Î¨∏ 4Í∞ú! üéä"
            }
        ];
        // ==================== ÏóêÎü¨ ÌëúÏãú ====================
        function showError(msg, isError = true) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.className = 'error-msg show';
            el.style.color = isError ? '#ff6b6b' : '#00b894';
            el.style.background = isError ? 'rgba(255,107,107,0.2)' : 'rgba(0,184,148,0.2)';
            setTimeout(() => el.classList.remove('show'), 3000);
        }
        
        // ==================== Î∞© Í¥ÄÎ¶¨ ====================
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ==================== ÏûÑÎ≤†Îìú Î™®Îìú(Colyseus Î∏åÎ¶øÏßÄ) ====================
        function startEmbedded(init){
            isGuestMode = false;
            isHost = !!init.isHost;
            roomId = String(init.roomCode || 'ROOM');
            playerId = String(init.sessionId || ('p_' + Date.now()));
            localPlayer.name = String(init.nick || 'ÌñÑÏ∞å').slice(0, 16);
            const seat = typeof init.seat === 'number' ? init.seat : 0;
            localPlayer.color = HAMSTER_COLORS[seat % HAMSTER_COLORS.length];
            currentLevel = 1;
            try{ tgEnded = false; }catch(e){}
            startGame();
            // Ï≤´ ÏÉÅÌÉú Ï†ÑÏÜ°
            bridgeSendState(true);
        }

        // createRoom()/joinRoom()/Firebase Î°úÏßÅ Ï†úÍ±∞: Ïô∏Î∂Ä Î°úÎπÑ(Colyseus)ÏóêÏÑú Î∞©/ÏûÖÏû•ÏùÑ Ï≤òÎ¶¨Ìï©ÎãàÎã§.
        
        function startGuestMode() {
            const name = document.getElementById('playerName').value.trim() || 'ÌñÑÏ∞å';
            
            isGuestMode = true;
            isHost = true;
            roomId = 'GUEST';
            playerId = 'guest_player';
            
            localPlayer.name = name;
            localPlayer.color = HAMSTER_COLORS[0];
            localPlayer.x = LEVELS[0].spawn.x;
            localPlayer.y = LEVELS[0].spawn.y;
            
            startGame();
        }
        
        function updatePlayerList() {
            const container = document.getElementById('playerList');
            let html = `<div class="player-item">
                <div class="player-dot" style="background:${localPlayer.color}"></div>
                <span>${localPlayer.name} ${isGuestMode ? '(Ïó∞ÏäµÏ§ë)' : '(ÎÇò)'}</span>
            </div>`;
            
            if (!isGuestMode) {
                Object.values(players).forEach(p => {
                    html += `<div class="player-item">
                        <div class="player-dot" style="background:${p.color}"></div>
                        <span>${p.name}</span>
                    </div>`;
                });
            }
            
            container.innerHTML = html;
        }
        
        // ==================== Í≤åÏûÑ ÏãúÏûë ====================
        function startGame() {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameContainer').style.display = 'flex';
            document.getElementById('displayRoomCode').textContent = isGuestMode ? 'üéÆ Ïó∞Ïäµ Î™®Îìú' : 'Î∞©: ' + roomId;
            
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Ïò§ÎîîÏò§ Ï¥àÍ∏∞Ìôî
            initAudio();
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            loadLevel(currentLevel);
            setupControls();
            updatePlayerList();
            gameLoop();
        }
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        function loadLevel(levelNum) {
            const level = LEVELS[levelNum - 1];
            if (!level) {
                // Î™®Îì† Î†àÎ≤® ÌÅ¥Î¶¨Ïñ¥
                document.getElementById('winScreen').querySelector('.win-text').textContent = 'üéä Í≤åÏûÑ ÌÅ¥Î¶¨Ïñ¥! üéä';
                document.getElementById('autoNextHint').style.display = 'none';
                document.getElementById('winScreen').classList.add('show');
                sfxGameClear();
                // Î©ÄÌã∞ ÏûÑÎ≤†Îìú: ÏÑ±Í≥µ -> Î∂ÄÎ™®/ÏÑúÎ≤ÑÎ°ú Í≤∞Í≥º Ï†ÑÏÜ° (ÏûêÎèô ÎåÄÍ∏∞Ïã§ Î≥µÍ∑Ä)
                bridgeSendOver(true, "game_clear");
                return;
            }
            
            document.getElementById('autoNextHint').style.display = 'block';
            document.getElementById('winScreen').querySelector('.win-text').textContent = 'üéâ Î†àÎ≤® ÌÅ¥Î¶¨Ïñ¥! üéâ';
            let levelMessage = level.message;
            if (isGuestMode && level.buttons.length > 0) {
                levelMessage = "Î∞ïÏä§Î•º Î∞ÄÏñ¥ÏÑú Î≤ÑÌäºÏùÑ ÎàåÎü¨Ïöî!";
            }
            document.getElementById('levelInfo').textContent = `Î†àÎ≤® ${levelNum} - ${levelMessage}`;
            document.getElementById('winScreen').classList.remove('show');
            
            // Í≤åÏûÑ Ïò§Î∏åÏ†ùÌä∏ Ï¥àÍ∏∞Ìôî
            gameObjects = {
                platforms: [...level.platforms],
                buttons: level.buttons.map(b => ({...b, pressed: false})),
                doors: level.doors.map(d => ({...d, open: false})),
                spikes: [...level.spikes],
                goal: {...level.goal},
                boxes: (level.boxes || []).map(b => ({...b, vx: 0, vy: 0}))
            };
            
            // ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò Ï¥àÍ∏∞Ìôî
            const colorIndex = HAMSTER_COLORS.indexOf(localPlayer.color);
            localPlayer.x = level.spawn.x + (colorIndex * 50);
            localPlayer.y = level.spawn.y;
            localPlayer.vx = 0;
            localPlayer.vy = 0;
            localPlayer.isDead = false;
            
            // ÎÑ§Ìä∏ÏõåÌÅ¨(Î∏åÎ¶øÏßÄ)Î°ú Ï¥àÍ∏∞ ÏúÑÏπò Ï†ÑÏÜ°
            bridgeSendState(true);

cameraX = 0;
        }
        
        function nextLevel() {
            if (isGuestMode) {
                currentLevel++;
                loadLevel(currentLevel);
            } else if (isHost) {
                currentLevel++;
                bridgeSend("tg_level", { level: currentLevel });
                loadLevel(currentLevel);
            }
        }
        
        // ==================== ÌÑ∞Ïπò Ïª®Ìä∏Î°§ ====================
        function setupControls() {
            // ÌÑ∞Ïπò ÏãúÏûë
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                
                for (let touch of e.changedTouches) {
                    touches[touch.identifier] = {
                        x: touch.clientX,
                        y: touch.clientY,
                        startX: touch.clientX
                    };
                }
                
                // Îëê Í∞ú Ïù¥ÏÉÅ ÌÑ∞Ïπò = Ï†êÌîÑ
                if (Object.keys(touches).length >= 2) {
                    if (localPlayer.onGround) {
                        localPlayer.vy = -15;
                        localPlayer.onGround = false;
                        sfxJump();
                    }
                } else {
                    // Îã®Ïùº ÌÑ∞Ïπò = Ïù¥Îèô Î∞©Ìñ• Í≤∞Ï†ï
                    updateMoveDirection();
                }
            });
            
            // ÌÑ∞Ïπò Ïù¥Îèô
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                for (let touch of e.changedTouches) {
                    if (touches[touch.identifier]) {
                        touches[touch.identifier].x = touch.clientX;
                        touches[touch.identifier].y = touch.clientY;
                    }
                }
                
                if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            // ÌÑ∞Ïπò Ï¢ÖÎ£å
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                
                for (let touch of e.changedTouches) {
                    delete touches[touch.identifier];
                }
                
                if (Object.keys(touches).length === 0) {
                    moveDirection = 0;
                } else if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                for (let touch of e.changedTouches) {
                    delete touches[touch.identifier];
                }
                if (Object.keys(touches).length === 0) {
                    moveDirection = 0;
                }
            });
            
            // ÎßàÏö∞Ïä§ Ïª®Ìä∏Î°§ (Îç∞Ïä§ÌÅ¨ÌÜ±) - ÌÑ∞ÏπòÏôÄ ÏôÑÏ†ÑÌûà ÎèôÏùºÌïú Î∞©Ïãù
            // Ï¢åÌÅ¥Î¶≠ = ÏÜêÍ∞ÄÎùΩ1, Ïö∞ÌÅ¥Î¶≠ = ÏÜêÍ∞ÄÎùΩ2
            canvas.addEventListener('mousedown', (e) => {
                e.preventDefault();
                initAudio();
                
                if (e.button === 0) { // ÏôºÏ™Ω ÌÅ¥Î¶≠ = ÏÜêÍ∞ÄÎùΩ 1
                    touches['mouseLeft'] = { x: e.clientX, y: e.clientY };
                } else if (e.button === 2) { // Ïò§Î•∏Ï™Ω ÌÅ¥Î¶≠ = ÏÜêÍ∞ÄÎùΩ 2
                    touches['mouseRight'] = { x: e.clientX, y: e.clientY };
                }
                
                // Îëê Í∞ú Ïù¥ÏÉÅ = Ï†êÌîÑ (ÌÑ∞ÏπòÏôÄ ÎèôÏùº)
                if (Object.keys(touches).length >= 2) {
                    if (localPlayer.onGround) {
                        localPlayer.vy = -15;
                        localPlayer.onGround = false;
                        sfxJump();
                    }
                } else {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (touches['mouseLeft']) {
                    touches['mouseLeft'] = { x: e.clientX, y: e.clientY };
                }
                if (touches['mouseRight']) {
                    touches['mouseRight'] = { x: e.clientX, y: e.clientY };
                }
                
                if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('mouseup', (e) => {
                if (e.button === 0) {
                    delete touches['mouseLeft'];
                } else if (e.button === 2) {
                    delete touches['mouseRight'];
                }
                
                if (Object.keys(touches).length === 0) {
                    moveDirection = 0;
                } else if (Object.keys(touches).length === 1) {
                    updateMoveDirection();
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                delete touches['mouseLeft'];
                delete touches['mouseRight'];
                moveDirection = 0;
            });
            
            // Ïö∞ÌÅ¥Î¶≠ Î©îÎâ¥ ÎπÑÌôúÏÑ±Ìôî
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // ÌÇ§Î≥¥Îìú Ïª®Ìä∏Î°§ÎèÑ Ïú†ÏßÄ (ÏÑ†ÌÉùÏ†Å ÏÇ¨Ïö©)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') moveDirection = -1;
                if (e.key === 'ArrowRight' || e.key === 'd') moveDirection = 1;
                if ((e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') && localPlayer.onGround) {
                    localPlayer.vy = -15;
                    localPlayer.onGround = false;
                    sfxJump();
                }
            });
            
            document.addEventListener('keyup', (e) => {
                if ((e.key === 'ArrowLeft' || e.key === 'a') && moveDirection === -1) moveDirection = 0;
                if ((e.key === 'ArrowRight' || e.key === 'd') && moveDirection === 1) moveDirection = 0;
            });
        }
        
        function updateMoveDirection() {
            const touchList = Object.values(touches);
            if (touchList.length === 0) {
                moveDirection = 0;
                return;
            }
            
            const touch = touchList[0];
            const screenCenter = window.innerWidth / 2;
            
            // ÌôîÎ©¥ Ï§ëÏïô Í∏∞Ï§ÄÏúºÎ°ú Î∞©Ìñ• Í≤∞Ï†ï
            if (touch.x < screenCenter) {
                moveDirection = -1;
            } else {
                moveDirection = 1;
            }
        }
        
        // ==================== Í≤åÏûÑ Î¨ºÎ¶¨ ====================
        function updatePhysics() {
            // Ïù¥Îèô
            const speed = 5;
            localPlayer.vx = moveDirection * speed;
            
            // Í±∑Í∏∞ Ìö®Í≥ºÏùå (ÎïÖÏóêÏÑú Ïù¥Îèô Ï§ëÏùº ÎïåÎßå)
            if (moveDirection !== 0 && localPlayer.onGround) {
                sfxStep();
            }
            
            // Ï§ëÎ†•
            localPlayer.vy += 0.6;
            if (localPlayer.vy > 15) localPlayer.vy = 15;
            
            // ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
            localPlayer.x += localPlayer.vx;
            localPlayer.y += localPlayer.vy;
            
            // ÌîåÎû´Ìèº Ï∂©Îèå
            localPlayer.onGround = false;
            
            for (let platform of gameObjects.platforms) {
                if (checkCollision(localPlayer, platform)) {
                    resolveCollision(localPlayer, platform);
                }
            }
            
            // Îã´Ìûå Î¨∏Í≥º Ï∂©Îèå
            for (let door of gameObjects.doors) {
                if (!door.open && checkCollision(localPlayer, door)) {
                    resolveCollision(localPlayer, door);
                }
            }
            
            // Î∞ïÏä§ Î¨ºÎ¶¨
            for (let box of gameObjects.boxes) {
                // Î∞ïÏä§ Ï§ëÎ†•
                box.vy += 0.6;
                if (box.vy > 15) box.vy = 15;
                
                // Î∞ïÏä§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                box.x += box.vx;
                box.y += box.vy;
                box.vx *= 0.8; // ÎßàÏ∞∞
                
                // Î∞ïÏä§-ÌîåÎû´Ìèº Ï∂©Îèå
                for (let platform of gameObjects.platforms) {
                    if (checkBoxCollision(box, platform)) {
                        resolveBoxCollision(box, platform);
                    }
                }
                
                // Î∞ïÏä§-Î¨∏ Ï∂©Îèå
                for (let door of gameObjects.doors) {
                    if (!door.open && checkBoxCollision(box, door)) {
                        resolveBoxCollision(box, door);
                    }
                }
            }
            
            // ÌîåÎ†àÏù¥Ïñ¥-Î∞ïÏä§ Ï∂©Îèå (Î∞ÄÍ∏∞)
            for (let box of gameObjects.boxes) {
                if (checkPlayerBoxCollision(localPlayer, box)) {
                    pushBox(localPlayer, box);
                }
            }
            
            // Î≤ÑÌäº Ï≤¥ÌÅ¨ (ÌîåÎ†àÏù¥Ïñ¥ ÎòêÎäî Î∞ïÏä§)
            gameObjects.buttons.forEach((button, idx) => {
                let somethingOnButton = false;
                
                // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Î≤ÑÌäº ÏúÑÏóê ÏûàÎäîÏßÄ
                const playerOnButton = localPlayer.x + 20 > button.x && 
                                localPlayer.x < button.x + button.width &&
                                localPlayer.y + 40 > button.y &&
                                localPlayer.y + 40 < button.y + button.height + 10;
                if (playerOnButton) somethingOnButton = true;
                
                // Î∞ïÏä§Í∞Ä Î≤ÑÌäº ÏúÑÏóê ÏûàÎäîÏßÄ
                for (let box of gameObjects.boxes) {
                    const boxOnButton = box.x + box.width/2 > button.x && 
                                       box.x < button.x + button.width &&
                                       box.y + box.height > button.y &&
                                       box.y + box.height < button.y + button.height + 10;
                    if (boxOnButton) somethingOnButton = true;
                }
                
                // Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Î≤ÑÌäº ÏúÑÏóê ÏûàÎäîÏßÄ (Î©ÄÌã∞ÌîåÎ†àÏù¥)
                if (!isGuestMode) {
                    Object.values(players).forEach(p => {
                        if (p.x + 20 > button.x && p.x < button.x + button.width &&
                            p.y + 40 > button.y && p.y + 40 < button.y + button.height + 10) {
                            somethingOnButton = true;
                        }
                    });
                }
                
                // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                if (somethingOnButton && !button.pressed) {
                    button.pressed = true;
                    sfxButton();
                    bridgeSend("tg_button", { idx, pressed: true });
                } else if (!somethingOnButton && button.pressed && !isGuestMode) {
                    // Î©ÄÌã∞ Î™®ÎìúÏóêÏÑúÎßå Î≤ÑÌäº Ìï¥Ï†ú (Í≤åÏä§Ìä∏ Î™®ÎìúÎäî Î∞ïÏä§Î°ú ÏòÅÍµ¨ Í≥†Ï†ï)
                    button.pressed = false;
                    bridgeSend("tg_button", { idx, pressed: false });
                }
            });
            
            localPlayer.onButton = gameObjects.buttons.some(btn => btn.pressed);
            
            updateDoors();
            
            // Ïù¥ÎØ∏ Ï£ΩÏùÄ ÏÉÅÌÉúÎ©¥ ÏÇ¨Îßù Ï≤òÎ¶¨ Ïä§ÌÇµ
            if (!localPlayer.isDead) {
                // Ïä§ÌååÏù¥ÌÅ¨ Ï∂©Îèå (ÏÇ¨Îßù)
                for (let spike of gameObjects.spikes) {
                    if (checkCollision(localPlayer, {...spike, height: 20})) {
                        onDeath();
                        return;
                    }
                }
                
                // ÎÇôÏÇ¨
                if (localPlayer.y > 1000) {
                    onDeath();
                    return;
                }
            }
            
            // Í≥® Ï≤¥ÌÅ¨
            const goal = gameObjects.goal;
            if (localPlayer.x + 20 > goal.x && localPlayer.x < goal.x + goal.width &&
                localPlayer.y + 40 > goal.y && localPlayer.y < goal.y + goal.height) {
                // 1Î™ÖÎßå ÎèÑÏ∞©Ìï¥ÎèÑ ÌÅ¥Î¶¨Ïñ¥
                if (!document.getElementById('winScreen').classList.contains('show')) {
                    sfxLevelClear();
                    document.getElementById('winScreen').classList.add('show');
                    setTimeout(() => nextLevel(), 1500);
                }
            }
            
            // ÎÑ§Ìä∏ÏõåÌÅ¨(Î∏åÎ¶øÏßÄ)Î°ú ÏÉÅÌÉú Ï†ÑÏÜ°
            bridgeSendState();
}
        
        function updateDoors() {
            gameObjects.doors.forEach((door, idx) => {
                const button = gameObjects.buttons.find(b => b.doorId === idx);
                const wasOpen = door.open;
                door.open = button ? button.pressed : false;
                if (!wasOpen && door.open) {
                    sfxDoorOpen();
                }
            });
        }
        
        function onDeath() {
            localPlayer.isDead = true;
            deathCount++;
            updateDeathCountUI();
            sfxDeath();
            
            if (isGuestMode) {
                // Í≤åÏä§Ìä∏ Î™®Îìú: Î∞îÎ°ú Îßµ Ï¥àÍ∏∞Ìôî
                showDeathEffect(() => {
                    resetMap();
                });
            } else {
                // Î©ÄÌã∞ ÌîåÎ†àÏù¥: Î∏åÎ¶øÏßÄÎ°ú ÏÇ¨Îßù ÏÉÅÌÉú Ï†ÑÏÜ°
                bridgeSendState(true);

                // Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥ ÏÇ¨Îßù Ï≤¥ÌÅ¨
                checkAllDead();
            }
        }
        
        function updateDeathCountUI() {
            document.getElementById('deathCount').textContent = 'üíÄ ' + deathCount;
        }
        
        function showDeathEffect(callback) {
            // Í∞ÑÎã®Ìïú ÏÇ¨Îßù Ïù¥ÌéôÌä∏ (ÌôîÎ©¥ ÍπúÎπ°ÏûÑ)
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255,0,0,0.3);
                z-index: 500;
                pointer-events: none;
            `;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.remove();
                if (callback) callback();
            }, 300);
        }
        
        function checkAllDead() {
            // Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏÇ¨ÎßùÌñàÎäîÏßÄ ÌôïÏù∏
            let allDead = localPlayer.isDead;
            
            Object.values(players).forEach(p => {
                if (!p.isDead) {
                    allDead = false;
                }
            });
            
            if (allDead && Object.keys(players).length > 0) {
                // ÏûÑÎ≤†Îìú Î©ÄÌã∞: Ï†ÑÏõê ÏÇ¨Îßù = Ïã§Ìå® -> Î∂ÄÎ™®/ÏÑúÎ≤ÑÎ°ú Í≤∞Í≥º Ï†ÑÏÜ°
                if (EMBED && !isGuestMode) {
                    bridgeSendOver(false, "all_dead");
                    return;
                }
                // Í∑∏ Ïô∏(Î°úÏª¨/Í≤åÏä§Ìä∏): Ìò∏Ïä§Ìä∏Îßå Îßµ Î¶¨ÏÖã Ìä∏Î¶¨Í±∞
                if (isHost) { bridgeSend("tg_reset", { t: Date.now() }); }
            } else if (allDead && Object.keys(players).length === 0) {
                // ÌòºÏûê ÌîåÎ†àÏù¥ Ï§ëÏù∏ Í≤ΩÏö∞(ÏûÑÎ≤†ÎìúÎ©¥ Ïã§Ìå®Î°ú Ï≤òÎ¶¨)
                if (EMBED && !isGuestMode) {
                    bridgeSendOver(false, "all_dead");
                    return;
                }
                showDeathEffect(() => { resetMap(); });
            }
        }
        
        function resetMap() {
            // Îßµ Ï¥àÍ∏∞Ìôî (Î≤ÑÌäº, Î¨∏ ÏÉÅÌÉú Î¶¨ÏÖã)
            loadLevel(currentLevel);
            localPlayer.isDead = false;
            
            // Î∏åÎ¶øÏßÄ: Î¶¨ÏÖã Ï†ÑÌåå(Ìò∏Ïä§Ìä∏Îßå)
            if (!isGuestMode && isHost) {
                bridgeSend("tg_reset", { t: Date.now() });
                gameObjects.buttons.forEach((btn, idx) => bridgeSend("tg_button", { idx, pressed: false }));
                bridgeSendState(true);
            }
        }
        
        function respawn() {
            // Í∏∞Ï°¥ respawnÏùÄ ÏúÑÏπòÎßå Î¶¨ÏÖã (ÏÇ¨Îßù ÏóÜÏù¥ ÏúÑÏπò Ï°∞Ï†ï ÌïÑÏöîÏãú ÏÇ¨Ïö©)
            const level = LEVELS[currentLevel - 1];
            const colorIndex = HAMSTER_COLORS.indexOf(localPlayer.color);
            localPlayer.x = level.spawn.x + (colorIndex * 50);
            localPlayer.y = level.spawn.y;
            localPlayer.vx = 0;
            localPlayer.vy = 0;
        }
        
        function checkCollision(player, rect) {
            return player.x + 40 > rect.x &&
                   player.x < rect.x + rect.width &&
                   player.y + 40 > rect.y &&
                   player.y < rect.y + rect.height;
        }
        
        function resolveCollision(player, rect) {
            const overlapX = Math.min(player.x + 40 - rect.x, rect.x + rect.width - player.x);
            const overlapY = Math.min(player.y + 40 - rect.y, rect.y + rect.height - player.y);
            
            if (overlapX < overlapY) {
                if (player.x < rect.x) {
                    player.x = rect.x - 40;
                } else {
                    player.x = rect.x + rect.width;
                }
                player.vx = 0;
            } else {
                if (player.y < rect.y) {
                    player.y = rect.y - 40;
                    player.onGround = true;
                    player.vy = 0;
                } else {
                    player.y = rect.y + rect.height;
                    player.vy = 0;
                }
            }
        }
        
        // Î∞ïÏä§ Ï∂©Îèå Ï≤¥ÌÅ¨
        function checkBoxCollision(box, rect) {
            return box.x + box.width > rect.x &&
                   box.x < rect.x + rect.width &&
                   box.y + box.height > rect.y &&
                   box.y < rect.y + rect.height;
        }
        
        // Î∞ïÏä§ Ï∂©Îèå Ìï¥Í≤∞
        function resolveBoxCollision(box, rect) {
            const overlapX = Math.min(box.x + box.width - rect.x, rect.x + rect.width - box.x);
            const overlapY = Math.min(box.y + box.height - rect.y, rect.y + rect.height - box.y);
            
            if (overlapX < overlapY) {
                if (box.x < rect.x) {
                    box.x = rect.x - box.width;
                } else {
                    box.x = rect.x + rect.width;
                }
                box.vx = 0;
            } else {
                if (box.y < rect.y) {
                    box.y = rect.y - box.height;
                    box.vy = 0;
                } else {
                    box.y = rect.y + rect.height;
                    box.vy = 0;
                }
            }
        }
        
        // ÌîåÎ†àÏù¥Ïñ¥-Î∞ïÏä§ Ï∂©Îèå Ï≤¥ÌÅ¨
        function checkPlayerBoxCollision(player, box) {
            return player.x + 40 > box.x &&
                   player.x < box.x + box.width &&
                   player.y + 40 > box.y &&
                   player.y < box.y + box.height;
        }
        
        // Î∞ïÏä§ Î∞ÄÍ∏∞
        function pushBox(player, box) {
            const overlapX = Math.min(player.x + 40 - box.x, box.x + box.width - player.x);
            const overlapY = Math.min(player.y + 40 - box.y, box.y + box.height - player.y);
            
            if (overlapX < overlapY) {
                // ÏòÜÏóêÏÑú Ï∂©Îèå - Î∞ïÏä§ Î∞ÄÍ∏∞
                sfxPush();
                if (player.x < box.x) {
                    box.vx = 3;
                    player.x = box.x - 40;
                } else {
                    box.vx = -3;
                    player.x = box.x + box.width;
                }
            } else {
                // ÏúÑÏïÑÎûò Ï∂©Îèå
                if (player.y < box.y) {
                    // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Î∞ïÏä§ ÏúÑÏóê Ï∞©ÏßÄ
                    player.y = box.y - 40;
                    player.onGround = true;
                    player.vy = 0;
                } else {
                    // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Î∞ïÏä§ ÏïÑÎûòÏóêÏÑú Î∂ÄÎî™Ìûò
                    player.y = box.y + box.height;
                    player.vy = 0;
                }
            }
        }
        
        // ==================== Î†åÎçîÎßÅ ====================
        function render() {
            // Î∞∞Í≤Ω
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ïπ¥Î©îÎùº Îî∞ÎùºÍ∞ÄÍ∏∞
            const targetCameraX = localPlayer.x - canvas.width / 2;
            cameraX += (targetCameraX - cameraX) * 0.1;
            cameraX = Math.max(0, cameraX);
            
            ctx.save();
            ctx.translate(-cameraX, 0);
            
            // Î∞∞Í≤Ω Î≥Ñ
            for (let i = 0; i < 50; i++) {
                const x = (i * 73 + cameraX * 0.1) % 2500;
                const y = (i * 47) % canvas.height;
                ctx.fillStyle = `rgba(255,255,255,${0.3 + Math.sin(Date.now() / 1000 + i) * 0.2})`;
                ctx.beginPath();
                ctx.arc(x, y, 1 + Math.random(), 0, Math.PI * 2);
                ctx.fill();
            }
            
            // ÌîåÎû´Ìèº
            gameObjects.platforms.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.width, p.height);
                
                // ÌïòÏù¥ÎùºÏù¥Ìä∏
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(p.x, p.y, p.width, 3);
            });
            
            // Î≤ÑÌäº
            gameObjects.buttons.forEach(b => {
                ctx.fillStyle = b.pressed ? '#2d3436' : b.color;
                ctx.fillRect(b.x, b.y + (b.pressed ? 10 : 0), b.width, b.height - (b.pressed ? 5 : 0));
                
                if (!b.pressed) {
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(b.x, b.y, b.width, 3);
                }
            });
            
            // Î¨∏
            gameObjects.doors.forEach(d => {
                if (!d.open) {
                    ctx.fillStyle = d.color;
                    ctx.fillRect(d.x, d.y, d.width, d.height);
                    
                    // Ìå®ÌÑ¥
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    for (let i = 0; i < 3; i++) {
                        ctx.fillRect(d.x + 5, d.y + 10 + i * 30, d.width - 10, 20);
                    }
                } else {
                    // Ïó¥Î¶∞ Î¨∏
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.fillRect(d.x, d.y, d.width, d.height);
                }
            });
            
            // Ïä§ÌååÏù¥ÌÅ¨
            gameObjects.spikes.forEach(s => {
                ctx.fillStyle = '#e74c3c';
                const spikeCount = Math.floor(s.width / 15);
                for (let i = 0; i < spikeCount; i++) {
                    ctx.beginPath();
                    ctx.moveTo(s.x + i * 15, s.y + s.height);
                    ctx.lineTo(s.x + i * 15 + 7.5, s.y);
                    ctx.lineTo(s.x + i * 15 + 15, s.y + s.height);
                    ctx.fill();
                }
            });
            
            // Î∞ïÏä§
            gameObjects.boxes.forEach(box => {
                // Í∑∏Î¶ºÏûê
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(box.x + 4, box.y + 4, box.width, box.height);
                
                // Î∞ïÏä§ Î≥∏Ï≤¥
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(box.x, box.y, box.width, box.height);
                
                // ÎÇòÎ¨¥ Î¨¥Îä¨
                ctx.fillStyle = '#a0522d';
                ctx.fillRect(box.x + 3, box.y + 3, box.width - 6, 8);
                ctx.fillRect(box.x + 3, box.y + box.height - 11, box.width - 6, 8);
                
                // ÌïòÏù¥ÎùºÏù¥Ìä∏
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.fillRect(box.x, box.y, box.width, 3);
                ctx.fillRect(box.x, box.y, 3, box.height);
                
                // ÌÖåÎëêÎ¶¨
                ctx.strokeStyle = '#5c3317';
                ctx.lineWidth = 2;
                ctx.strokeRect(box.x, box.y, box.width, box.height);
            });
            
            // Í≥® - ÍπÉÎ∞úÎßå ÌëúÏãú
            const goal = gameObjects.goal;
            const flagX = goal.x + goal.width / 2;
            const flagY = goal.y - 30; // Îçî ÎÜíÍ≤å
            const flagHeight = goal.height + 30;
            
            // ÍπÉÎ∞ú Í∏∞Îë•
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(flagX - 3, flagY, 6, flagHeight);
            
            // ÍπÉÎ∞ú Ï≤ú
            ctx.beginPath();
            ctx.moveTo(flagX + 3, flagY);
            ctx.lineTo(flagX + 45, flagY + 22);
            ctx.lineTo(flagX + 3, flagY + 44);
            ctx.closePath();
            ctx.fillStyle = '#ff6b6b';
            ctx.fill();
            
            // Î∞òÏßùÏù¥ ÌååÌã∞ÌÅ¥ 2~3Í∞ú (ÏûêÏó∞Ïä§ÎüΩÍ≤å Îñ†Îã§ÎãàÎäî ÎäêÎÇå)
            const time = Date.now() / 1000;
            for (let i = 0; i < 3; i++) {
                const px = flagX + 20 + Math.sin(time * 0.8 + i * 2.5) * 25;
                const py = flagY + 20 + Math.cos(time * 0.6 + i * 2) * 20 + i * 10;
                const alpha = 0.6 + Math.sin(time * 2 + i) * 0.4;
                ctx.fillStyle = `rgba(255, 255, 150, ${alpha})`;
                ctx.beginPath();
                ctx.arc(px, py, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Îì§ (Î∂ÄÎìúÎü¨Ïö¥ Î≥¥Í∞Ñ)
            Object.entries(players).forEach(([sid, tp]) => {
                const sp = smoothedPlayers[sid] || (smoothedPlayers[sid] = { x: tp.x||0, y: tp.y||0 });
                // Î™©Ìëú ÏúÑÏπòÎ°ú Î∂ÄÎìúÎüΩÍ≤å Ïù¥Îèô (ÎÑ§Ìä∏ÏõåÌÅ¨ ÎÅäÍπÄ ÎäêÎÇå ÏôÑÌôî)
                const k = 0.22; // lerp factor
                sp.x += ((tp.x||0) - sp.x) * k;
                sp.y += ((tp.y||0) - sp.y) * k;
                // Í∏∞ÌÉÄ ÏÜçÏÑ±ÏùÄ Ï¶âÏãú Î∞òÏòÅ
                sp.color = tp.color;
                sp.name = tp.name;
                sp.isDead = !!tp.isDead;
                drawHamster(sp.x, sp.y, sp.color, sp.name, false, sp.isDead);
            });
// Î°úÏª¨ ÌîåÎ†àÏù¥Ïñ¥
            drawHamster(localPlayer.x, localPlayer.y, localPlayer.color, localPlayer.name, true, localPlayer.isDead);
            
            ctx.restore();
        }
        
        function drawHamster(x, y, color, name, isLocal = false, isDead = false) {
            // ÏÇ¨Îßù Ïãú Î∞òÌà¨Î™Ö Ï≤òÎ¶¨
            if (isDead) {
                ctx.globalAlpha = 0.4;
            }
            
            // Í∑∏Î¶ºÏûê
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(x + 20, y + 38, 14, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Î™∏ÌÜµ (Îë•Í∏ÄÎë•Í∏ÄÌïú ÏõêÌòï)
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.ellipse(x + 20, y + 22, 18, 16, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Í∑Ä (Îë•Í∑º Í∑Ä)
            ctx.beginPath();
            ctx.arc(x + 6, y + 8, 7, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 34, y + 8, 7, 0, Math.PI * 2);
            ctx.fill();
            
            // Í∑Ä ÏïàÏ™Ω (Î∂ÑÌôçÏÉâ)
            ctx.fillStyle = '#ffb8b8';
            ctx.beginPath();
            ctx.arc(x + 6, y + 8, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 34, y + 8, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Î≥º (ÌÜµÌÜµÌïú Î≥ºÏÇ¥)
            ctx.fillStyle = 'rgba(255,184,184,0.6)';
            ctx.beginPath();
            ctx.ellipse(x + 6, y + 26, 6, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(x + 34, y + 26, 6, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Îàà (ÏûëÍ≥† ÎèôÍ∑∏ÎûÄ Îàà)
            ctx.fillStyle = '#2d3436';
            ctx.beginPath();
            ctx.arc(x + 14, y + 20, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 26, y + 20, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Îàà ÌïòÏù¥ÎùºÏù¥Ìä∏
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(x + 15, y + 19, 1.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 27, y + 19, 1.2, 0, Math.PI * 2);
            ctx.fill();
            
            // ÏΩî (ÏûëÏùÄ Î∂ÑÌôç ÏΩî)
            ctx.fillStyle = '#ff9999';
            ctx.beginPath();
            ctx.arc(x + 20, y + 26, 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Ïù¥Î¶ÑÌëú
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.beginPath();
            ctx.roundRect(x - 5, y - 15, 50, 14, 7);
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.font = '9px Jua';
            ctx.textAlign = 'center';
            ctx.fillText(name, x + 20, y - 4);
            
            // Î°úÏª¨ ÌîåÎ†àÏù¥Ïñ¥ ÌëúÏãú (ÏûëÏùÄ ÌôîÏÇ¥Ìëú)
            if (isLocal && !isDead) {
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.moveTo(x + 20, y - 23);
                ctx.lineTo(x + 15, y - 30);
                ctx.lineTo(x + 25, y - 30);
                ctx.closePath();
                ctx.fill();
            }
            
            // ÏÇ¨Îßù Ïãú X ÌëúÏãú
            if (isDead) {
                ctx.globalAlpha = 1;
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x + 10, y + 12);
                ctx.lineTo(x + 30, y + 32);
                ctx.moveTo(x + 30, y + 12);
                ctx.lineTo(x + 10, y + 32);
                ctx.stroke();
            }
            
            // globalAlpha Î≥µÏõê
            ctx.globalAlpha = 1;
        }
        
        // ==================== Í≤åÏûÑ Î£®ÌîÑ ====================
        function gameLoop() {
            updatePhysics();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        
        // ==================== Colyseus Î∏åÎ¶øÏßÄ (Firebase Ï†úÍ±∞) ====================
        let mySessionId = null;
        let mySeat = 0;
        let tgEnded = false; // embed Î©ÄÌã∞ÏóêÏÑú Í≤∞Í≥º Ï†ÑÏÜ° Ï§ëÎ≥µ Î∞©ÏßÄ

        function bridgeSendOver(success, reason){
            if (!EMBED || isGuestMode) return;
            if (!isHost) return;
            if (tgEnded) return;
            tgEnded = true;
            bridgeSend("tg_over", { success: !!success, reason: reason || (success ? "clear" : "fail") });
        }

        function applyRemotePlayers(map){
            const next = {};
            if (!map) map = {};
            for (const [sid, p] of Object.entries(map)){
                if (sid === mySessionId) continue;
                next[sid] = p;
                // init smoothing slot
                if (!smoothedPlayers[sid]){
                    smoothedPlayers[sid] = { x: p.x||0, y: p.y||0, vx: p.vx||0, vy: p.vy||0, isDead: !!p.isDead };
                }
                // keep name/color immediately (no alpha)
                smoothedPlayers[sid].name = p.name;
                smoothedPlayers[sid].color = p.color;
            }
            players = next;
            // prune removed
            for (const sid of Object.keys(smoothedPlayers)){
                if (!players[sid]) delete smoothedPlayers[sid];
            }
            updatePlayerList();
        }

        function applyButtons(btnMap){
            if (!btnMap || !gameObjects?.buttons) return;
            for (const [idxStr, pressed] of Object.entries(btnMap)){
                const idx = parseInt(idxStr, 10);
                if (gameObjects.buttons[idx]) gameObjects.buttons[idx].pressed = !!pressed;
            }
            updateDoors();
        }

        function bridgeSendState(force=false){
            if (!EMBED || isGuestMode) return;
            const now = performance.now();
            if (!force && bridgeSendState._t && (now - bridgeSendState._t) < 33) return; // ~20Hz
            bridgeSendState._t = now;
            bridgeSend("tg_state", {
                state: {
                    x: localPlayer.x, y: localPlayer.y,
                    vx: localPlayer.vx, vy: localPlayer.vy,
                    onGround: !!localPlayer.onGround,
                    onButton: !!localPlayer.onButton,
                    isDead: !!localPlayer.isDead,
                    color: localPlayer.color,
                    name: localPlayer.name,
                    level: currentLevel,
                    deathCount
                }
            });
        }

        // Embed Î™®Îìú ÏßÑÏûÖ: ÎÇ¥Î∂Ä Î°úÎπÑ/ÏÑ§Ï†ï UI Ï†úÍ±∞, Î∂ÄÎ™®ÏóêÍ≤å Ï§ÄÎπÑ Ïã†Ìò∏
        if (EMBED){
            try{
                const lobby = document.getElementById('lobby');
                if (lobby){
                    // Î°úÎπÑ UIÎäî Î∂ÄÎ™® Î°úÎπÑÎ•º ÏÇ¨Ïö©ÌïòÎØÄÎ°ú ÏµúÏÜåÌôî
                    const hide = lobby.querySelectorAll('button, details, .input-group');
                    hide.forEach(el => el.style.display = 'none');
                    const subtitle = lobby.querySelector('.lobby-subtitle');
                    if (subtitle) subtitle.textContent = 'Ïó∞Í≤∞ Ï§ë...';
                }
                bridgeSend("bridge_ready", {});
            }catch(e){}
        }

        window.addEventListener("message", (e)=>{
            const d = e.data || {};
            if (!d || typeof d !== "object") return;

            if (d.type === "bridge_init"){
                mySessionId = String(d.sessionId || "");
                mySeat = typeof d.seat === "number" ? d.seat : 0;
                startEmbedded({
                    nick: d.nick || "ÌñÑÏ∞å",
                    seat: mySeat,
                    isHost: !!d.isHost,
                    sessionId: mySessionId,
                    roomCode: d.roomCode || "ROOM"
                });
                if (d.players) applyRemotePlayers(d.players);
                if (d.level) {
                    const lv = parseInt(d.level, 10);
                    if (lv) { currentLevel = lv; }
                }
                return;
            }

            if (d.type === "tg_players"){
                applyRemotePlayers(d.players || {});
                return;
            }

            if (d.type === "tg_level"){
                const lv = parseInt(d.level, 10);
                if (lv && lv !== currentLevel){
                    currentLevel = lv;
                    loadLevel(currentLevel);
                }
                return;
            }

            if (d.type === "tg_buttons"){
                applyButtons(d.buttons || {});
                return;
            }

            if (d.type === "tg_button"){
                if (gameObjects?.buttons && gameObjects.buttons[d.idx]){
                    gameObjects.buttons[d.idx].pressed = !!d.pressed;
                    updateDoors();
                }
                return;
            }

            if (d.type === "tg_reset"){
                showDeathEffect(()=> resetMap());
                return;
            }
        });

// ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ï†ÄÏû•Îêú Ïù¥Î¶Ñ Î≥µÏõê
        const savedName = localStorage.getItem('playerName');
        if (savedName) {
            document.getElementById('playerName').value = savedName;
        }
        
        document.getElementById('playerName').addEventListener('change', (e) => {
            localStorage.setItem('playerName', e.target.value);
        });
    </script>
</body>
</html>
