<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Í∑∏Î¶ºÎßûÏ∂îÍ∏∞</title>
  <style>
    :root{
      --bg:#f4ece1;
      --paper:#ffffff;
      --accent:#8d6e63;
      --text:#4e342e;
      --muted:rgba(78,52,46,.65);
      --danger:#d32f2f;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Pretendard', sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-user-select:none;
      user-select:none;
    }
    header{
      width:100%;
      max-width:1020px;
      margin:0 auto 10px auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:-0.2px;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
    }
    .timer{
      font-size:18px;
      font-weight:800;
      color:var(--danger);
      min-width:76px;
      text-align:right;
    }
    .game{
      width:100%;
      max-width:1020px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:stretch;
    }
    .toolbar{
      width:74px;
      background:rgba(255,255,255,.55);
      border:2px solid var(--accent);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .toolbarBtns{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    .palette{
      width:100%;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      padding-top:4px;
    }
    .color{
      width:28px;
      height:28px;
      border-radius:14px;
      border:2px solid #fff;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      font-weight:900;
      color:rgba(0,0,0,.70);
      user-select:none;
    }
    .color.eraser{
      background:repeating-linear-gradient(45deg,#ffffff,#ffffff 6px,#f0f0f0 6px,#f0f0f0 12px);
      border:2px solid rgba(0,0,0,.10);
    }
    .color.active{ outline:3px solid rgba(141,110,99,.55); }
    .btn{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(141,110,99,.14);
      color:var(--text);
      font-weight:700;
      font-size:14px;
      letter-spacing:-0.2px;
      line-height:1.2;
      white-space:nowrap;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.4; cursor:not-allowed; }
    .canvasWrap{
      flex: 1.2;
      background:var(--paper);
      border:1px solid rgba(0,0,0,.12);
      border-radius:10px;
      box-shadow: 4px 4px 14px rgba(0,0,0,.08);
      position:relative;
      min-height:520px;
      overflow:hidden;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      cursor:crosshair;
    }
    .side{
      flex: .8;
      min-width:260px;
      max-width:360px;
      display:flex;
      flex-direction:column;
      gap:10px;
      height:520px;
    }
    .chat{
      flex:1;
      background:#fff;
      border:2px solid var(--accent);
      border-radius:12px;
      padding:10px;
      overflow:auto;
      font-size:13px;
      line-height:1.35;
    }
    .row{
      display:flex;
      gap:6px;
    }
    input{
      flex:1;
      padding:10px;
      border-radius:10px;
      border:2px solid var(--accent);
      font-size:14px;
      outline:none;
    }
    .send{
      padding:10px 12px;
      border-radius:10px;
      border:none;
      background:var(--accent);
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(141,110,99,.12);
      border:1px solid rgba(141,110,99,.2);
      font-size:12px;
      color:var(--text);
    }
    .sys{ color:#2b5; font-weight:800; }
    .warn{ color:var(--danger); font-weight:800; }
    .hint{ color:var(--muted); }
    .mobileWordBar{
      display:none;
      width:100%;
      max-width:1020px;
      margin:0 auto 10px auto;
      padding:10px 12px;
      border-radius:14px;
      border:2px solid var(--accent);
      background:rgba(255,255,255,.72);
      font-weight:900;
      letter-spacing:-0.3px;
      color:var(--text);
    }
    @media (max-width: 860px){
      .game{ flex-direction:column; }
      /* Mobile: buttons on top, palette below (horizontal) */
      .toolbar{ flex-direction:column; width:100%; align-items:stretch; }
      .toolbarBtns{ flex-direction:row; gap:10px; }
      .btn{ width:50%; }
      .palette{ padding-top:10px; }
      .mobileWordBar{ display:block; }
      .side{ max-width:none; min-width:unset; height:320px; }
      .canvasWrap{ min-height:360px; height:360px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>üñåÔ∏è Í∑∏Î¶ºÎßûÏ∂îÍ∏∞</h1>
      <div class="meta">
        <span class="pill" id="roundPill">ÎùºÏö¥Îìú -/-</span>
        <span class="pill" id="turnPill">Ï∞®Î°Ä: -</span>
        <span class="pill" id="wordPill">Ï†úÏãúÏñ¥: ???</span>
      </div>
    </div>
    <div class="timer" id="timer">02:00</div>
  </header>

  <div class="mobileWordBar" id="mobileWordBar">Ï†úÏãúÏñ¥: ???</div>

  <div class="game">
    <div class="toolbar">
      <div class="toolbarBtns">
        <button class="btn" id="clearBtn" disabled>ÏßÄÏö∞Í∏∞</button>
        <button class="btn" id="quitBtn">ÎÇòÍ∞ÄÍ∏∞</button>
      </div>
      <div class="palette" aria-label="ÏÉâÏÉÅ ÏÑ†ÌÉù">
        <div class="color" data-c="#000000" style="background:#000000;"></div>
        <div class="color" data-c="#e74c3c" style="background:#e74c3c;"></div>
        <div class="color" data-c="#3498db" style="background:#3498db;"></div>
        <div class="color" data-c="#2ecc71" style="background:#2ecc71;"></div>
        <div class="color" data-c="#f1c40f" style="background:#f1c40f;"></div>
        <div class="color eraser" data-tool="eraser" title="ÏßÄÏö∞Í∞ú">üßΩ</div>
      </div>
    </div>

    <div class="canvasWrap">
      <canvas id="c"></canvas>
    </div>

    <div class="side">
      <div class="chat" id="chat"></div>
      <div class="row">
        <input id="input" type="text" placeholder="Ï†ïÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÌïúÍ∏Ä)" maxlength="30" />
        <button class="send" id="send">Ï†ÑÏÜ°</button>
      </div>
      <div class="hint" id="hint">Í∑∏Î¶¨Îäî ÏÇ¨ÎûåÎßå Í∑∏Î¶ºÏùÑ Í∑∏Î¶¥ Ïàò ÏûàÏñ¥Ïöî.</div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clearBtn');
    const quitBtn = document.getElementById('quitBtn');

    const roundPill = document.getElementById('roundPill');
    const turnPill  = document.getElementById('turnPill');
    const wordPill  = document.getElementById('wordPill');
    const timerEl   = document.getElementById('timer');
    const hintEl    = document.getElementById('hint');
    const mobileWordBar = document.getElementById('mobileWordBar');

    const BASE_W = 900;
    const BASE_H = 650;

    let mySid = '';
    let myNick = 'Player';
    let isDrawer = false;
    let drawerNick = '-';
    let currentWord = '';
    let endAt = 0;
    let round = 0;
    let maxRounds = 5;

    // draw state
    let strokeColor = '#000000';
    let strokeWidth = 5;
    let painting = false;
    let lastX = 0, lastY = 0;
    let sendBuf = [];
    let lastSendAt = 0;

    function clamp01(v){ return Math.max(0, Math.min(1, v)); }

    function resizeCanvas(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(280, Math.floor(rect.width));
      const h = Math.max(240, Math.floor(rect.height));
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }

    function clearLocal(){
      ctx.clearRect(0,0, canvas.width, canvas.height);
    }

    function drawSeg(x1,y1,x2,y2,color,w){
      const rect = canvas.getBoundingClientRect();
      const px1 = x1 * rect.width;
      const py1 = y1 * rect.height;
      const px2 = x2 * rect.width;
      const py2 = y2 * rect.height;

      ctx.save();
      if (color === '__erase__') {
        // Eraser: punch holes in the canvas (transparent)
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,1)';
        ctx.lineWidth = Math.max(10, (w || 4) * 2.2);
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = color;
        ctx.lineWidth = Math.max(1, w);
      }
      ctx.beginPath();
      ctx.moveTo(px1, py1);
      ctx.lineTo(px2, py2);
      ctx.stroke();
      ctx.restore();
    }

    function addChatLine(html){
      const div = document.createElement('div');
      div.innerHTML = html;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function sendToParent(obj){
      try{ window.parent.postMessage(obj, '*'); }catch(_){ }
    }

    // colors (+ eraser)
    const colorBtns = Array.from(document.querySelectorAll('.color'));
    function setColorOrTool(btn){
      if (!btn) return;
      if (btn.dataset.tool === 'eraser') strokeColor = '__erase__';
      else strokeColor = btn.dataset.c || '#000000';

      for(const b of colorBtns){
        const isE = b.dataset.tool === 'eraser';
        const active = isE ? (strokeColor === '__erase__') : (b.dataset.c === strokeColor);
        b.classList.toggle('active', !!active);
      }
    }
    for(const b of colorBtns){
      b.addEventListener('click', ()=> setColorOrTool(b));
    }
    // initial
    setColorOrTool(colorBtns.find(b => (b.dataset.c === strokeColor)) || colorBtns[0]);

    function setDrawer(v){
      isDrawer = !!v;
      clearBtn.disabled = !isDrawer;
      hintEl.textContent = isDrawer ? 'ÎãπÏã† Ï∞®Î°Ä! (Í∑∏Î¶¨Í∏∞ Í∞ÄÎä•)' : 'Í∑∏Î¶¨Îäî ÏÇ¨ÎûåÎßå Í∑∏Î¶ºÏùÑ Í∑∏Î¶¥ Ïàò ÏûàÏñ¥Ïöî.';
      if (!isDrawer) currentWord = '';
      wordPill.textContent = isDrawer && currentWord ? `Ï†úÏãúÏñ¥: ${currentWord}` : 'Ï†úÏãúÏñ¥: ???';
      if (mobileWordBar){
        mobileWordBar.textContent = isDrawer && currentWord
          ? `ÏßÄÍ∏à Í∑∏Î¶¥ Í≤É: ${currentWord}`
          : `Ï∞®Î°Ä: ${drawerNick || '-'}`;
      }
    }

    // input/send
    function sendChat(){
      const t = String(inputEl.value||'').trim();
      if(!t) return;
      inputEl.value = '';
      sendToParent({ type:'da_chat', text: t });
    }
    sendBtn.addEventListener('click', sendChat);
    inputEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendChat(); });

    clearBtn.addEventListener('click', ()=>{
      if(!isDrawer) return;
      clearLocal();
      sendToParent({ type:'da_clear' });
    });

    quitBtn.addEventListener('click', ()=>{
      sendToParent({ type:'da_quit' });
    });

    // pointer events
    function getNormPos(ev){
      const rect = canvas.getBoundingClientRect();
      const x = (ev.clientX - rect.left) / rect.width;
      const y = (ev.clientY - rect.top) / rect.height;
      return { x: clamp01(x), y: clamp01(y) };
    }

    canvas.addEventListener('pointerdown', (ev)=>{
      if(!isDrawer) return;
      painting = true;
      canvas.setPointerCapture(ev.pointerId);
      const p = getNormPos(ev);
      lastX = p.x; lastY = p.y;
    });

    canvas.addEventListener('pointermove', (ev)=>{
      if(!painting || !isDrawer) return;
      const p = getNormPos(ev);
      sendBuf.push([lastX, lastY, p.x, p.y]);
      drawSeg(lastX, lastY, p.x, p.y, strokeColor, strokeWidth);
      lastX = p.x; lastY = p.y;
    });

    function endPaint(){
      painting = false;
    }
    canvas.addEventListener('pointerup', endPaint);
    canvas.addEventListener('pointercancel', endPaint);
    canvas.addEventListener('pointerleave', endPaint);

    // batch send strokes (min server load)
    setInterval(()=>{
      if(!isDrawer) { sendBuf = []; return; }
      if(!sendBuf.length) return;
      const now = Date.now();
      if (now - lastSendAt < 45) return;
      lastSendAt = now;
      const segs = sendBuf;
      sendBuf = [];
      sendToParent({ type:'da_draw', segs, c: strokeColor, w: strokeWidth });
    }, 50);

    // timer
    function fmt(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const r = String(s%60).padStart(2,'0');
      return `${m}:${r}`;
    }
    setInterval(()=>{
      const left = endAt ? (endAt - Date.now()) : 120000;
      timerEl.textContent = fmt(left);
    }, 250);

    // bridge messages
    window.addEventListener('message', (ev)=>{
      const d = ev.data || {};
      if(!d || typeof d !== 'object') return;
      if (d.type === 'bridge_init'){
        mySid = String(d.sessionId || d.mySid || '');
        myNick = String(d.nick || d.myNick || 'Player');
        addChatLine(`<span class="sys">ÏãúÏä§ÌÖú:</span> Ïó∞Í≤∞Îê® (${myNick})`);
        sendToParent({ type:'da_sync' });
        return;
      }

      if (d.type === 'da_state'){
        round = Number(d.round||0);
        maxRounds = Number(d.maxRounds||5);
        drawerNick = String(d.drawerNick||'-');
        endAt = Number(d.endAt||0);
        const youAreDrawer = !!d.youAreDrawer;
        setDrawer(youAreDrawer);
        roundPill.textContent = `ÎùºÏö¥Îìú ${round}/${maxRounds}`;
        turnPill.textContent = `Ï∞®Î°Ä: ${drawerNick}`;
        if (mobileWordBar){
          mobileWordBar.textContent = youAreDrawer && currentWord
            ? `ÏßÄÍ∏à Í∑∏Î¶¥ Í≤É: ${currentWord}`
            : `Ï∞®Î°Ä: ${drawerNick}`;
        }
        // scores (optional)
        if (d.announce){
          addChatLine(`<span class="sys">ÏãúÏä§ÌÖú:</span> ${escapeHtml(String(d.announce))}`);
        }
        return;
      }

      if (d.type === 'da_word'){
        currentWord = String(d.word || '');
        if (isDrawer){
          wordPill.textContent = currentWord ? `Ï†úÏãúÏñ¥: ${currentWord}` : 'Ï†úÏãúÏñ¥: ???';
        }
        if (mobileWordBar){
          mobileWordBar.textContent = isDrawer && currentWord
            ? `ÏßÄÍ∏à Í∑∏Î¶¥ Í≤É: ${currentWord}`
            : `Ï∞®Î°Ä: ${drawerNick || '-'}`;
        }
        return;
      }

      if (d.type === 'da_draw'){
        const segs = Array.isArray(d.segs) ? d.segs : [];
        const c = String(d.c || '#000000');
        const w = Number(d.w || 5);
        for(const s of segs){
          if(!Array.isArray(s) || s.length < 4) continue;
          drawSeg(Number(s[0])||0, Number(s[1])||0, Number(s[2])||0, Number(s[3])||0, c, w);
        }
        return;
      }

      if (d.type === 'da_clear'){
        clearLocal();
        return;
      }

      if (d.type === 'da_replay'){
        clearLocal();
        const ops = Array.isArray(d.ops) ? d.ops : [];
        for(const op of ops){
          if(!op || typeof op !== 'object') continue;
          if(op.t === 'clear'){
            clearLocal();
            continue;
          }
          if(op.t === 'draw'){
            const segs = Array.isArray(op.segs) ? op.segs : [];
            const c = String(op.c || '#000000');
            const w = Number(op.w || 5);
            for(const s of segs){
              if(!Array.isArray(s) || s.length < 4) continue;
              drawSeg(Number(s[0])||0, Number(s[1])||0, Number(s[2])||0, Number(s[3])||0, c, w);
            }
          }
        }
        return;
      }

      if (d.type === 'da_chat'){
        const nick = escapeHtml(String(d.nick||'Player'));
        const text = escapeHtml(String(d.text||''));
        if (d.system){
          addChatLine(`<span class="sys">ÏãúÏä§ÌÖú:</span> ${text}`);
        } else if (d.correct){
          addChatLine(`<span class="sys">Ï†ïÎãµ!</span> <b>${nick}</b> : ${text}`);
        } else {
          addChatLine(`<b>${nick}</b>: ${text}`);
        }
        return;
      }

      if (d.type === 'da_over'){
        const winner = escapeHtml(String(d.winnerNick||'ÏäπÏûê'));
        addChatLine(`<span class="warn">Í≤åÏûÑ Ï¢ÖÎ£å</span> : ${winner}`);
        setDrawer(false);
        endAt = 0;
        return;
      }
    });

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
    }

    // boot
    addChatLine(`<span class="sys">ÏãúÏä§ÌÖú:</span> Î°úÎî©...`);
    window.addEventListener('resize', ()=>{ try{ resizeCanvas(); }catch(_){ } });
    resizeCanvas();

    // standalone fallback (dev)
    if (window.parent === window){
      mySid = 'local';
      myNick = 'Î°úÏª¨';
      setDrawer(true);
      roundPill.textContent = 'ÎùºÏö¥Îìú 1/5';
      turnPill.textContent = 'Ï∞®Î°Ä: Î°úÏª¨';
      currentWord = 'ÏÇ¨Í≥º';
      wordPill.textContent = 'Ï†úÏãúÏñ¥: ÏÇ¨Í≥º';
      endAt = Date.now() + 120000;
      addChatLine(`<span class="sys">ÏãúÏä§ÌÖú:</span> Î°úÏª¨ ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îìú`);
    }
  </script>
</body>
</html>
